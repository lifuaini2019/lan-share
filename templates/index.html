<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥–å®‡å­—æ–‡å…±äº«</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- ç§»é™¤Socket.IOåº“ï¼Œä½¿ç”¨åŸç”ŸWebSocket -->
</head>
<body>
<!-- å®¢æœæ¨¡æ¿èœå• -->
<div class="template-sidebar" id="templateSidebar">
    <div class="sidebar-header">
        <h3>ğŸ’¬ èœå•æ ç›®</h3>
        <button class="close-btn mobile-only" onclick="toggleTemplateSidebar()">Ã—</button>
    </div>
    <div class="sidebar-content">
        <div class="category-menu" id="categoryMenu">
            <!-- åˆ†ç±»èœå•å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- æœåŠ¡å™¨ä¿¡æ¯å’ŒäºŒç»´ç åŒºåŸŸ -->
        <div class="sidebar-footer">
            <!-- æ‰«ç è®¿é—®åŒºåŸŸï¼ˆç½®äºä¸Šæ–¹ï¼‰ -->
            <div class="qr-section-sidebar">
                <div class="qr-header-sidebar">
                    <h4>ğŸ“± æ‰«ç è®¿é—®</h4>
                </div>
                
                <div class="qr-content-sidebar" id="sidebar-qr-content">
                    <div class="qr-image-container-sidebar">
                        <img id="sidebarQrImage" alt="äºŒç»´ç " class="qr-image-sidebar" 
                             onload="console.log('âœ… ä¾§è¾¹æ äºŒç»´ç åŠ è½½æˆåŠŸ!'); console.log('ğŸ” äºŒç»´ç æ•°æ®é•¿åº¦:', this.src.length);" 
                             onerror="console.log('âŒ ä¾§è¾¹æ äºŒç»´ç åŠ è½½å¤±è´¥!'); console.log('ğŸ” å¤±è´¥çš„äºŒç»´ç æ•°æ®:', this.src); this.parentNode.innerHTML='<p class=error>äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>'" />
                    </div>
                </div>
            </div>
            
            <!-- æœåŠ¡å™¨ä¿¡æ¯åŒºåŸŸï¼ˆç½®äºä¸‹æ–¹ï¼‰ -->
            <div class="server-info-sidebar">
                <h4>ğŸ“¡ æœåŠ¡å™¨ä¿¡æ¯</h4>
                <div class="server-url-display">{{.server_url}}</div>
                <button onclick="copySidebarUrl()" class="copy-sidebar-btn">
                    ğŸ“‹ å¤åˆ¶åœ°å€
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ä¸»å†…å®¹åŒºåŸŸ -->
<div class="main-content" id="mainContent">
    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleTemplateSidebar()">
        ğŸ’¬ èœå•æ ç›®
    </button>
    
    <!-- å…±äº«æ–‡å­—ç•Œé¢ -->
    <div class="interface-container" id="textShareInterface">
        <div class="container">
            <h2>
                ğŸ“ ç¥–å®‡å­—æ–‡å…±äº« 
                <span id="connection-status" class="connection-status">ğŸ”´ è¿æ¥ä¸­...</span>
                <span id="network-type" class="network-type">ğŸŒ {{.network_type}}</span>
            </h2>
            
            <!-- ä¸»è¦è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <h3>âœï¸ æ·»åŠ æ–‡å­—å†…å®¹</h3>
                <textarea id="content" 
                          placeholder="åœ¨è¿™é‡Œè¾“å…¥æˆ–ç²˜è´´æ–‡å­—å†…å®¹...&#10;ğŸ’¡ ç”µè„‘ç«¯æŒ‰å›è½¦é”®å¿«é€Ÿæäº¤" 
                          onkeydown="handleKeyPress(event)"></textarea>
                <button onclick="addMessage()" class="submit-btn">ğŸ“¤ æäº¤å†…å®¹</button>
            </div>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ -->
            <div class="messages-section">
                <div class="messages-header">
                    <h3>ğŸ“‹ å·²ä¿å­˜çš„å†…å®¹</h3>
                    <button onclick="showUploadModal()" class="upload-btn" title="å‘é€æ–‡ä»¶">
                        ğŸ“¤ å‘é€æ–‡ä»¶
                    </button>
                </div>
                
                <!-- æ–‡ä»¶ä¼ è¾“é€šçŸ¥åŒºåŸŸ - ç½®é¡¶æ˜¾ç¤º -->
                <div class="file-notifications" id="fileNotifications" style="display: none;">
                    <h4>ğŸ“ æ–‡ä»¶ä¼ è¾“é€šçŸ¥</h4>
                    <div id="fileNotificationsList" class="file-notifications-list">
                        <!-- æ–‡ä»¶é€šçŸ¥å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div id="messages">
                    {{range .messages}}
                    <div class="message" data-time="{{.Time}}">
                        <div class="content">{{.Content}}</div>
                        <div class="message-footer">
                            <div class="message-actions">
                                <button onclick="copyMessage(this)" class="copy-btn">ğŸ“‹ å¤åˆ¶</button>
                                <button onclick="addMessageToTemplate(this)" class="add-to-template-btn">â• æ·»åŠ åˆ°æ ç›®</button>
                                <button onclick="deleteMessage(this)" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                            <span class="time">â° {{.Time}}</span>
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
            
            <!-- äºŒç»´ç åŒºåŸŸï¼ˆæ”¾åœ¨åº•éƒ¨ï¼‰ -->
            <div class="qr-section" id="qr-section">
                <div class="qr-header">
                    <h3>ğŸ“± æ‰«ç å¿«é€Ÿè®¿é—®</h3>
                    <button onclick="toggleQR()" id="toggle-btn" class="toggle-btn">
                        ğŸ‘€ æ˜¾ç¤ºäºŒç»´ç 
                    </button>
                </div>
                
                <div class="qr-content" id="qr-content" style="display: none;">
                    <div class="server-info">
                        <p><strong>æœåŠ¡å™¨åœ°å€ï¼š</strong></p>
                        <div class="url-display">{{.server_url}}</div>
                        <button onclick="copyMainUrl()" class="copy-url-btn">
                            ğŸ“‹ å¤åˆ¶åœ°å€
                        </button>
                    </div>
                    
                    <div class="qr-image-container">
                        <img id="mainQrImage" alt="äºŒç»´ç " class="qr-image" 
                             onload="console.log('âœ… äºŒç»´ç åŠ è½½æˆåŠŸ!'); console.log('ğŸ” ä¸»äºŒç»´ç æ•°æ®é•¿åº¦:', this.src.length);" 
                             onerror="console.log('âŒ äºŒç»´ç åŠ è½½å¤±è´¥!'); console.log('ğŸ” å¤±è´¥çš„äºŒç»´ç æ•°æ®:', this.src); this.parentNode.innerHTML='<p class=error>äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>'" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…¶ä»–ç•Œé¢ -->
    <!-- å”®å‰é—®é¢˜ç•Œé¢ -->
    <div class="interface-container" id="presaleInterface" style="display: none;">
        <div class="container">
            <h2>ğŸ’¬ å”®å‰é—®é¢˜</h2>
            <div class="template-content-area">
                <div id="presaleTemplates" class="template-display-area">
                    <!-- å”®å‰æ¨¡æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€’é—®é¢˜ç•Œé¢ -->
    <div class="interface-container" id="expressInterface" style="display: none;">
        <div class="container">
            <h2>ğŸ“¦ å¿«é€’é—®é¢˜</h2>
            <div class="template-content-area">
                <div id="expressTemplates" class="template-display-area">
                    <!-- å¿«é€’æ¨¡æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- å”®åé—®é¢˜ç•Œé¢ -->
    <div class="interface-container" id="aftersaleInterface" style="display: none;">
        <div class="container">
            <h2>ğŸ› ï¸ å”®åé—®é¢˜</h2>
            <div class="template-content-area">
                <div id="aftersaleTemplates" class="template-display-area">
                    <!-- å”®åæ¨¡æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- è´­ä¹°é“¾æ¥ç•Œé¢ -->
    <div class="interface-container" id="purchaseInterface" style="display: none;">
        <div class="container">
            <h2>ğŸ›’ è´­ä¹°é“¾æ¥</h2>
            <div class="template-content-area">
                <div id="purchaseTemplates" class="template-display-area">
                    <!-- è´­ä¹°é“¾æ¥æ¨¡æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç»´ä¿®é—®é¢˜ç•Œé¢ -->
    <div class="interface-container" id="repairInterface" style="display: none;">
        <div class="container">
            <h2>ğŸ”§ ç»´ä¿®é—®é¢˜</h2>
            <div class="template-content-area">
                <div id="repairTemplates" class="template-display-area">
                    <!-- ç»´ä¿®é—®é¢˜æ¨¡æ¿å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç³»ç»Ÿè®¾ç½®ç•Œé¢ -->
    <div class="interface-container" id="settingsInterface" style="display: none;">
        <div class="container">
            <h2>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h2>
            <div class="settings-content-area">
                <!-- æ·»åŠ å†…å®¹åŠŸèƒ½åŒºåŸŸ -->
                <div class="add-content-section">
                    <h3>â• æ·»åŠ å†…å®¹</h3>
                    
                    <div class="add-content-form">
                        <div class="form-group">
                            <label for="categorySelect">é€‰æ‹©æ ç›®ï¼š</label>
                            <select id="categorySelect" class="form-select">
                                <!-- æ ç›®é€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="templateTitle">æ¨¡æ¿æ ‡é¢˜ï¼š</label>
                            <input type="text" id="templateTitle" class="form-input" placeholder="è¯·è¾“å…¥æ¨¡æ¿æ ‡é¢˜...">
                        </div>
                        
                        <div class="form-group">
                            <label for="templateContent">æ¨¡æ¿å†…å®¹ï¼š</label>
                            <textarea id="templateContent" class="form-textarea" rows="4" placeholder="è¯·è¾“å…¥æ¨¡æ¿å†…å®¹..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button onclick="addNewTemplate()" class="action-btn add-btn">
                                â• æ·»åŠ æ¨¡æ¿
                            </button>
                            <button onclick="clearAddForm()" class="action-btn clear-btn">
                                ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç®¡ç†ç°æœ‰å†…å®¹åŠŸèƒ½åŒºåŸŸ -->
                <div class="manage-content-section">
                    <div class="manage-header">
                        <h3>ğŸ“‹ ç®¡ç†ç°æœ‰å†…å®¹</h3>
                        <button onclick="clearAllTemplates()" class="action-btn clear-all-btn" title="åˆ é™¤æ‰€æœ‰æ ç›®çš„æ‰€æœ‰æ¨¡æ¿">
                            ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰å†…å®¹
                        </button>
                    </div>
                    
                    <div class="manage-controls">
                        <div class="form-group">
                            <label for="manageCategorySelect">é€‰æ‹©æ ç›®ï¼š</label>
                            <select id="manageCategorySelect" class="form-select" onchange="loadCategoryTemplates()">
                                <option value="">è¯·é€‰æ‹©æ ç›®...</option>
                                <!-- æ ç›®é€‰é¡¹å°†ç”±JavaScriptç”Ÿæˆ -->
                            </select>
                        </div>
                        
                        <!-- å•ä¸ªæ ç›®åˆ é™¤æŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼‰ -->
                        <div id="categoryDeleteContainer" class="category-delete-container" style="display: none;">
                            <button onclick="clearCategoryTemplates()" class="action-btn clear-category-btn">
                                ğŸ—‘ï¸ åˆ é™¤æœ¬æ ç›®æ‰€æœ‰å†…å®¹
                            </button>
                        </div>
                    </div>
                    
                    <div id="templatesList" class="templates-list">
                        <div class="no-selection">è¯·é€‰æ‹©æ ç›®æŸ¥çœ‹å…¶ä¸­çš„æ¨¡æ¿</div>
                    </div>
                </div>
                
                <!-- å¯¼å…¥å¯¼å‡ºåŠŸèƒ½åŒºåŸŸ -->
                <div class="import-export-section">
                    <h3>ğŸ“¦ æ•°æ®ç®¡ç†</h3>
                    
                    <!-- å¯¼å‡ºåŠŸèƒ½ -->
                    <div class="export-section">
                        <h4>ğŸ“¤ å¯¼å‡ºæ•°æ®</h4>
                        <div class="export-options">
                            <div class="option-group">
                                <label>å¯¼å‡ºæ ¼å¼ï¼š</label>
                                <div class="radio-group">
                                    <input type="radio" id="exportTxt" name="exportFormat" value="txt" checked>
                                    <label for="exportTxt">TXTæ–‡æœ¬æ ¼å¼</label>
                                    
                                    <input type="radio" id="exportJson" name="exportFormat" value="json">
                                    <label for="exportJson">JSONæ ¼å¼ï¼ˆé«˜çº§ï¼‰</label>
                                </div>
                            </div>
                            
                            <div class="option-group">
                                <label>å¯¼å‡ºèŒƒå›´ï¼š</label>
                                <div class="radio-group">
                                    <input type="radio" id="exportAll" name="exportType" value="all" checked>
                                    <label for="exportAll">å…¨éƒ¨æ•°æ®</label>
                                    
                                    <input type="radio" id="exportSelected" name="exportType" value="selected">
                                    <label for="exportSelected">æŒ‡å®šæ ç›®</label>
                                </div>
                            </div>
                            
                            <div class="category-selection" id="exportCategorySelection" style="display: none;">
                                <label>é€‰æ‹©æ ç›®ï¼š</label>
                                <div class="checkbox-group" id="exportCategoryList">
                                    <!-- æ ç›®é€‰æ‹©å°†ç”±JavaScriptç”Ÿæˆ -->
                                </div>
                            </div>
                            
                            <button onclick="exportTemplates()" class="action-btn export-btn">
                                ğŸ“ å¯¼å‡ºæ•°æ®
                            </button>
                        </div>
                    </div>
                    
                    <!-- å¯¼å…¥åŠŸèƒ½ -->
                    <div class="import-section">
                        <h4>ğŸ“¥ å¯¼å…¥æ•°æ®</h4>
                        <div class="import-options">
                            <div class="file-input-group">
                                <label for="importFile">é€‰æ‹©æ–‡ä»¶ï¼š</label>
                                <input type="file" id="importFile" accept=".txt,.json" class="file-input">
                                <small style="color: #6c757d; margin-top: 5px; display: block;">æ”¯æŒ TXT å’Œ JSON æ ¼å¼æ–‡ä»¶</small>
                            </div>
                            
                            <div class="option-group">
                                <label>å¯¼å…¥æ¨¡å¼ï¼š</label>
                                <div class="radio-group">
                                    <input type="radio" id="importMerge" name="importMode" value="merge" checked>
                                    <label for="importMerge">åˆå¹¶æ¨¡å¼ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼‰</label>
                                    
                                    <input type="radio" id="importReplace" name="importMode" value="replace">
                                    <label for="importReplace">æ›¿æ¢æ¨¡å¼ï¼ˆè¦†ç›–ç°æœ‰æ•°æ®ï¼‰</label>
                                </div>
                            </div>
                            
                            <div class="option-group">
                                <label>å¯¼å…¥èŒƒå›´ï¼š</label>
                                <div class="radio-group">
                                    <input type="radio" id="importAllCategories" name="importRange" value="all" checked>
                                    <label for="importAllCategories">å…¨éƒ¨æ ç›®</label>
                                    
                                    <input type="radio" id="importSelectedCategories" name="importRange" value="selected">
                                    <label for="importSelectedCategories">æŒ‡å®šæ ç›®</label>
                                </div>
                            </div>
                            
                            <div class="category-selection" id="importCategorySelection" style="display: none;">
                                <label>é€‰æ‹©æ ç›®ï¼š</label>
                                <div class="checkbox-group" id="importCategoryList">
                                    <!-- æ ç›®é€‰æ‹©å°†ç”±JavaScriptç”Ÿæˆ -->
                                </div>
                            </div>
                            
                            <button onclick="importTemplates()" class="action-btn import-btn">
                                ğŸ“Š å¯¼å…¥æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–‡ä»¶å®æ—¶ä¼ è¾“æ¨¡æ€æ¡† -->
<div id="uploadModal" class="upload-modal" style="display: none;">
    <div class="upload-modal-dialog">
        <div class="upload-modal-header">
            <h3>ğŸ“¤ å®æ—¶æ–‡ä»¶ä¼ è¾“</h3>
            <button onclick="closeUploadModal()" class="close-btn">&times;</button>
        </div>
        <div class="upload-modal-body">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p style="color: #28a745; font-weight: 500;">å±€åŸŸç½‘æ‰€æœ‰è®¾å¤‡éƒ½èƒ½åŒæ—¶æ”¶åˆ°ï¼</p>
                <input type="file" id="fileInput" multiple style="display: none;">
                <button onclick="document.getElementById('fileInput').click()" class="select-file-btn">é€‰æ‹©æ–‡ä»¶</button>
            </div>
            
            <!-- ä¼ è¾“æ¨¡å¼é€‰æ‹© -->
            <div class="transfer-mode-section">
                <h4>ğŸ”„ æ¥æ”¶æ¨¡å¼ï¼š</h4>
                <div class="mode-options">
                    <label class="mode-option">
                        <input type="radio" name="transferMode" value="exclusive" checked>
                        <span class="mode-title">ğŸ¯ ç‹¬å æ¨¡å¼</span>
                        <span class="mode-desc">ä¸€ä¸ªäººæ¥æ”¶åï¼Œå…¶ä»–äººè‡ªåŠ¨å–æ¶ˆ</span>
                    </label>
                    <label class="mode-option">
                        <input type="radio" name="transferMode" value="shared">
                        <span class="mode-title">ğŸ¤ å…±äº«æ¨¡å¼</span>
                        <span class="mode-desc">æ‰€æœ‰äººéƒ½èƒ½åŒæ—¶æ¥æ”¶æ–‡ä»¶</span>
                    </label>
                </div>
            </div>
            
            <div class="upload-info">
                <p><strong>æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼š</strong></p>
                <p>æ–‡æ¡£ï¼š.txt .pdf .doc .docx .xls .xlsx .ppt .pptx</p>
                <p>å›¾ç‰‡ï¼š.png .jpg .jpeg .gif</p>
                <p>å‹ç¼©æ–‡ä»¶ï¼š.zip .rar</p>
                <p><strong>æœ€å¤§æ–‡ä»¶å¤§å°ï¼š</strong>16MB</p>
            </div>
            <div id="selectedFiles" class="selected-files" style="display: none;">
                <h4>å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</h4>
                <ul id="fileList"></ul>
            </div>
        </div>
        <div class="upload-modal-footer">
            <button onclick="closeUploadModal()" class="cancel-btn">å–æ¶ˆ</button>
            <button onclick="sendFiles()" class="upload-submit-btn" id="uploadSubmitBtn" disabled>ğŸš€ å‘é€æ–‡ä»¶</button>
        </div>
    </div>
</div>

<script>
// åŠ è½½äºŒç»´ç åŠŸèƒ½
function loadQRCodes() {
    console.log('ğŸ”„ å¼€å§‹åŠ è½½äºŒç»´ç ...');
    
    fetch('/qr-code')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… äºŒç»´ç æ•°æ®è·å–æˆåŠŸ:', data);
            
            // è®¾ç½®ä¸»äºŒç»´ç 
            const mainQrImage = document.getElementById('mainQrImage');
            if (mainQrImage && data.qr_data_url) {
                mainQrImage.src = data.qr_data_url;
                console.log('âœ… ä¸»äºŒç»´ç å·²è®¾ç½®');
            }
            
            // è®¾ç½®ä¾§è¾¹æ äºŒç»´ç 
            const sidebarQrImage = document.getElementById('sidebarQrImage');
            if (sidebarQrImage && data.qr_data_url) {
                sidebarQrImage.src = data.qr_data_url;
                console.log('âœ… ä¾§è¾¹æ äºŒç»´ç å·²è®¾ç½®');
            }
            
            // æ›´æ–°ç½‘ç»œç±»å‹æ˜¾ç¤º
            const networkTypeElement = document.getElementById('network-type');
            if (networkTypeElement && data.network_type) {
                networkTypeElement.textContent = `ğŸŒ ${data.network_type}`;
                console.log('âœ… ç½‘ç»œç±»å‹å·²æ›´æ–°:', data.network_type);
            }
        })
        .catch(error => {
            console.error('âŒ åŠ è½½äºŒç»´ç å¤±è´¥:', error);
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const mainQrImage = document.getElementById('mainQrImage');
            if (mainQrImage) {
                mainQrImage.parentNode.innerHTML = '<p class="error">äºŒç»´ç åŠ è½½å¤±è´¥</p>';
            }
            
            const sidebarQrImage = document.getElementById('sidebarQrImage');
            if (sidebarQrImage) {
                sidebarQrImage.parentNode.innerHTML = '<p class="error">äºŒç»´ç åŠ è½½å¤±è´¥</p>';
            }
        });
}

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
    loadQRCodes();
    initializeSocket();
    loadTemplatesData();
});

// WebSocket å®æ—¶åŒæ­¥åŠŸèƒ½ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
let socket = null;
let isConnected = false;
let retryCount = 0;
const maxRetries = 3;

// åˆå§‹åŒ–WebSocketè¿æ¥
function initializeSocket() {
    console.log('ğŸ”Œ å¼€å§‹åˆå§‹åŒ–WebSocket...');
    
    try {
        updateConnectionStatus('ğŸ”„ è¿æ¥ä¸­...', 'connecting');
        // ä½¿ç”¨Goçš„WebSocketç«¯ç‚¹
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        socket = new WebSocket(wsUrl);
        setupSocketEvents();
    } catch (error) {
        console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
        updateConnectionStatus('ğŸ“¡ æ™®é€šæ¨¡å¼', 'normal');
    }
}

// è®¾ç½®Socketäº‹ä»¶
function setupSocketEvents() {
    if (!socket) {
        console.log('âŒ Socketå¯¹è±¡ä¸å­˜åœ¨');
        return;
    }
    
    console.log('ğŸ”§ è®¾ç½®Socketäº‹ä»¶ç›‘å¬å™¨...');
    
    socket.onopen = function() {
        isConnected = true;
        retryCount = 0;
        updateConnectionStatus('âœ… å®æ—¶åŒæ­¥', 'connected');
        console.log('âœ… WebSocket è¿æ¥æˆåŠŸ');
    };
    
    socket.onerror = function(error) {
        console.error('âŒ WebSocket è¿æ¥é”™è¯¯:', error);
        updateConnectionStatus('âŒ è¿æ¥å¤±è´¥', 'error');
    };
    
    socket.onclose = function(event) {
        isConnected = false;
        console.log('âŒ WebSocket è¿æ¥æ–­å¼€:', event.reason);
        updateConnectionStatus('âŒ è¿æ¥æ–­å¼€', 'disconnected');
    };
    
    socket.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('ğŸ”” æ”¶åˆ°æ¶ˆæ¯:', data);
            
            switch(data.type) {
                case 'connected':
                    console.log('âœ… WebSocket è¿æ¥ç¡®è®¤');
                    break;
                case 'new_message':
                    if (data.data.action === 'add') {
                        addMessageToUI(data.data.time, data.data.content);
                        showNotification('ğŸ”” æ”¶åˆ°æ–°æ¶ˆæ¯');
                    }
                    break;
                case 'message_deleted':
                    if (data.data.action === 'delete') {
                        removeMessageFromUI(data.data.time);
                        showNotification('ğŸ—‘ï¸ æ¶ˆæ¯å·²åˆ é™¤');
                    }
                    break;
                case 'file_incoming':
                    console.log('ğŸ“ æ”¶åˆ°æ–‡ä»¶:', data.data);
                    showIncomingFileNotification(data.data);
                    break;
                case 'file_received_notification':
                    console.log('ğŸ“‹ æ–‡ä»¶å·²è¢«æ¥æ”¶:', data.data);
                    handleFileReceivedNotification(data.data);
                    break;
                case 'sync_data':
                    // å¤„ç†åŒæ­¥æ•°æ®
                    break;
            }
        } catch (error) {
            console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
        }
    };
    
    console.log('ğŸš€ Socketäº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
}

// æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
function updateConnectionStatus(text, status) {
    const statusElement = document.getElementById('connection-status');
    if (statusElement) {
        statusElement.textContent = text;
        statusElement.className = `connection-status ${status}`;
    }
}

// æ˜¾ç¤ºé€šçŸ¥
function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    
    // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
    let backgroundColor, iconColor;
    switch(type) {
        case 'warning':
            backgroundColor = '#ff9800';
            iconColor = '#fff';
            break;
        case 'error':
            backgroundColor = '#f44336';
            iconColor = '#fff';
            break;
        case 'info':
            backgroundColor = '#2196f3';
            iconColor = '#fff';
            break;
        default: // success
            backgroundColor = '#4caf50';
            iconColor = '#fff';
    }
    
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${backgroundColor};
        color: ${iconColor};
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        max-width: 400px;
        word-wrap: break-word;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, type === 'warning' ? 4000 : 3000); // è­¦å‘Šæ¶ˆæ¯æ˜¾ç¤ºç¨é•¿ä¸€äº›
}

// æ·»åŠ æ¶ˆæ¯åˆ°UI
function addMessageToUI(time, content) {
    const existingMessage = document.querySelector(`[data-time="${time}"]`);
    if (existingMessage) return;
    
    const msgDiv = document.createElement('div');
    msgDiv.className = 'message';
    msgDiv.dataset.time = time;
    msgDiv.innerHTML = `
        <div class="content">${content}</div>
        <div class="message-footer">
            <div class="message-actions">
                <button onclick="copyMessage(this)" class="copy-btn">ğŸ“‹ å¤åˆ¶</button>
                <button onclick="addMessageToTemplate(this)" class="add-to-template-btn">â• æ·»åŠ åˆ°æ ç›®</button>
                <button onclick="deleteMessage(this)" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
            <span class="time">â° ${time}</span>
        </div>
    `;
    document.getElementById('messages').appendChild(msgDiv);
    msgDiv.scrollIntoView({ behavior: 'smooth' });
}

// ä» UI ä¸­ç§»é™¤æ¶ˆæ¯
function removeMessageFromUI(time) {
    const messageElement = document.querySelector(`[data-time="${time}"]`);
    if (messageElement) {
        messageElement.style.animation = 'fadeOut 0.3s ease-out';
        setTimeout(() => {
            if (messageElement.parentNode) {
                messageElement.parentNode.removeChild(messageElement);
            }
        }, 300);
    }
}

// å¤„ç†å›è½¦é”®äº‹ä»¶
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        addMessage();
    }
}

function addMessage() {
    const content = document.getElementById('content').value.trim();
    if(!content) {
        alert("ğŸ“ è¯·è¾“å…¥æ–‡å­—å†…å®¹");
        return;
    }
    
    fetch('/add', {
        method:'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: 'content=' + encodeURIComponent(content)
    }).then(r=>{
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
    }).then(res=>{
        if(res.success){
            document.getElementById('content').value='';
            document.getElementById('content').focus();
            
            // å¦‚æœæ²¡æœ‰WebSocketè¿æ¥ï¼Œæ‰‹åŠ¨æ·»åŠ åˆ°UI
            if (!isConnected) {
                addMessageToUI(res.time, res.content);
            }
        } else {
            alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }).catch(err => {
        console.error('æäº¤é”™è¯¯:', err);
        alert(`ç½‘ç»œé”™è¯¯: ${err.message}`);
    });
}

function deleteMessage(btn){
    const div = btn.closest('.message');
    const time = div.dataset.time;
    
    if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†…å®¹å—ï¼Ÿ')) return;
    
    fetch('/delete', {
        method:'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: 'time=' + encodeURIComponent(time)
    }).then(r=>{
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        return r.json();
    }).then(res=>{
        if(res.success) {
            // å¦‚æœæ²¡æœ‰WebSocketè¿æ¥ï¼Œæ‰‹åŠ¨ä» UI ç§»é™¤
            if (!isConnected) {
                div.remove();
            }
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }).catch(err => {
        console.error('åˆ é™¤é”™è¯¯:', err);
        alert(`ç½‘ç»œé”™è¯¯: ${err.message}`);
    });
}

function copyMessage(btn){
    const content = btn.closest('.message').querySelector('.content').innerText;
    console.log('ğŸ“‹ å°è¯•å¤åˆ¶æ¶ˆæ¯å†…å®¹:', content);
    
    // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        console.log('ä½¿ç”¨ Clipboard API å¤åˆ¶æ¶ˆæ¯...');
        navigator.clipboard.writeText(content).then(() => {
            console.log('âœ… Clipboard API å¤åˆ¶æˆåŠŸ');
            showMessageCopySuccess(btn);
        }).catch((error) => {
            console.error('âŒ Clipboard API å¤±è´¥:', error);
            fallbackCopyMessage(content, btn);
        });
    } else {
        console.log('âš ï¸ Clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ fallback');
        fallbackCopyMessage(content, btn);
    }
}

// æ¶ˆæ¯å¤åˆ¶çš„ fallback æ–¹æ³•
function fallbackCopyMessage(text, btn) {
    try {
        console.log('ä½¿ç”¨ execCommand å¤åˆ¶æ¶ˆæ¯...');
        
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            console.log('âœ… execCommand å¤åˆ¶æˆåŠŸ');
            showMessageCopySuccess(btn);
        } else {
            throw new Error('execCommand è¿”å› false');
        }
    } catch (error) {
        console.error('âŒ execCommand ä¹Ÿå¤±è´¥:', error);
        showManualCopyModal(text);
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯å¤åˆ¶æˆåŠŸçš„åé¦ˆ
function showMessageCopySuccess(btn) {
    const originalText = btn.innerHTML;
    const originalBackground = btn.style.background;
    
    btn.innerHTML = 'âœ… å·²å¤åˆ¶';
    btn.style.background = '#28a745';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = originalBackground;
    }, 1500);
    
    showNotification('ğŸ“‹ æ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

// æ·»åŠ æ¶ˆæ¯åˆ°æ¨¡æ¿æ ç›®
function addMessageToTemplate(btn) {
    const content = btn.closest('.message').querySelector('.content').innerText;
    const time = btn.closest('.message').dataset.time;
    
    console.log('ğŸ”„ æ·»åŠ æ¶ˆæ¯åˆ°æ¨¡æ¿:', content);
    console.log('ğŸ” æ£€æŸ¥ templatesData:', templatesData);
    
    // æ£€æŸ¥æ¨¡æ¿æ•°æ®æ˜¯å¦å­˜åœ¨
    if (!templatesData || !templatesData.categories) {
        alert('æ¨¡æ¿æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    // åˆ›å»ºæ ç›®é€‰æ‹©æ¨¡æ€æ¡†
    showCategorySelectionModal(content, time, btn);
}

// æ˜¾ç¤ºæ ç›®é€‰æ‹©æ¨¡æ€æ¡†
function showCategorySelectionModal(content, time, sourceBtn) {
    // åˆ›å»ºæ¨¡æ€æ¡†
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 25px;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        overflow-y: auto;
    `;
    
    // ç”Ÿæˆæ ç›®é€‰é¡¹
    let categoryOptions = '';
    for (const [key, category] of Object.entries(templatesData.categories)) {
        if (key !== 'settings') { // æ’é™¤ç³»ç»Ÿè®¾ç½®
            categoryOptions += `<option value="${key}">${category.icon} ${category.name}</option>`;
        }
    }
    
    dialog.innerHTML = `
        <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center;">
            â• æ·»åŠ åˆ°æ ç›®
        </h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">é€‰æ‹©æ ç›®ï¼š</label>
            <select id="modalCategorySelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <option value="">è¯·é€‰æ‹©æ ç›®...</option>
                ${categoryOptions}
            </select>
        </div>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">æ¨¡æ¿æ ‡é¢˜ï¼š</label>
            <input type="text" id="modalTemplateTitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="è¯·è¾“å…¥æ¨¡æ¿æ ‡é¢˜..." value="å…±äº«å†…å®¹ ${time}">
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">æ¨¡æ¿å†…å®¹ï¼š</label>
            <textarea id="modalTemplateContent" style="width: 100%; height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;" readonly>${content}</textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="this.closest('.category-modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                å–æ¶ˆ
            </button>
            <button onclick="confirmAddToTemplate('${content.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${time}')" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                âœ… ç¡®è®¤æ·»åŠ 
            </button>
        </div>
    `;
    
    modal.className = 'category-modal';
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // èšç„¦åˆ°æ ç›®é€‰æ‹©
    setTimeout(() => {
        document.getElementById('modalCategorySelect').focus();
    }, 100);
}

// ç¡®è®¤æ·»åŠ åˆ°æ¨¡æ¿
function confirmAddToTemplate(content, time) {
    const categoryKey = document.getElementById('modalCategorySelect').value;
    let title = document.getElementById('modalTemplateTitle').value.trim();
    const templateContent = document.getElementById('modalTemplateContent').value.trim();
    
    if (!categoryKey) {
        alert('è¯·é€‰æ‹©æ ç›®');
        return;
    }
    
    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å…¥é»˜è®¤å€¼
    if (!title) {
        title = 'æœªè¯´æ˜';
        // åŒæ—¶æ›´æ–°ç•Œé¢æ˜¾ç¤º
        document.getElementById('modalTemplateTitle').value = title;
    }
    
    if (!templateContent) {
        alert('æ¨¡æ¿å†…å®¹ä¸èƒ½ä¸ºç©º');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const confirmBtn = document.querySelector('.category-modal button[onclick*="confirmAddToTemplate"]');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = 'ğŸ”„ æ·»åŠ ä¸­...';
    confirmBtn.disabled = true;
    
    // å‘é€è¯·æ±‚
    fetch(`/api/templates/category/${categoryKey}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            title: title,
            content: templateContent
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.category-modal').remove();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            if (result.is_duplicate) {
                showNotification('âš ï¸ ' + result.message);
            } else {
                showNotification('âœ… å·²æˆåŠŸæ·»åŠ åˆ°æ ç›®ï¼');
            }
            
            // é‡æ–°åŠ è½½æ¨¡æ¿æ•°æ®
            setTimeout(() => {
                initializeTemplates();
            }, 500);
        } else {
            alert('æ·»åŠ å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('æ·»åŠ æ¨¡æ¿é”™è¯¯:', error);
        alert('æ·»åŠ å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

function toggleQR() {
    const qrContent = document.getElementById('qr-content');
    const toggleBtn = document.getElementById('toggle-btn');
    
    if (qrContent.style.display === 'none') {
        qrContent.style.display = 'block';
        toggleBtn.innerHTML = 'ğŸ™ˆ éšè—äºŒç»´ç ';
    } else {
        qrContent.style.display = 'none';
        toggleBtn.innerHTML = 'ğŸ‘€ æ˜¾ç¤ºäºŒç»´ç ';
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
// === å®¢æœæ¨¡æ¿åŠŸèƒ½ ===
let templatesData = null;
let currentInterface = 'home'; // å½“å‰æ˜¾ç¤ºçš„ç•Œé¢

// æ¨¡æ¿æ•°æ®åŠ è½½å‡½æ•°ï¼ˆé‡å‘½åä»¥é¿å…æ··æ·†ï¼‰
function loadTemplatesData() {
    console.log('ğŸ”§ å¼€å§‹åŠ è½½å®¢æœæ¨¡æ¿æ•°æ®...');
    fetch('/api/templates')
        .then(response => {
            console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… æ¨¡æ¿æ•°æ®åŠ è½½æˆåŠŸ:', data);
            templatesData = data;
            renderCategoryMenu();
            // é»˜è®¤æ˜¾ç¤ºå…±äº«é¦–é¡µ
            switchInterface('home');
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            initializeFileUpload();
            
            // è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
            document.getElementById('content').focus();
        })
        .catch(error => {
            console.error('âŒ åŠ è½½æ¨¡æ¿æ•°æ®å¤±è´¥:', error);
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            const menuContainer = document.getElementById('categoryMenu');
            if (menuContainer) {
                menuContainer.innerHTML = '<div style="padding: 20px; color: #ff6b6b; text-align: center;">âš ï¸ æ¨¡æ¿åŠ è½½å¤±è´¥<br>è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        });
}

// æ¸²æŸ“åˆ†ç±»èœå•
function renderCategoryMenu() {
    const menuContainer = document.getElementById('categoryMenu');
    let menuHTML = '';
    
    // æ·»åŠ å…±äº«æ–‡å­—é€‰é¡¹
    menuHTML += `
        <div class="category-item ${currentInterface === 'home' ? 'active' : ''}" onclick="switchInterface('home')" data-category="home">
            <span class="category-icon">ğŸ </span>
            <span class="category-name">å…±äº«æ–‡å­—</span>
        </div>
    `;
    
    // æ·»åŠ å…¶ä»–åˆ†ç±»
    for (const [key, category] of Object.entries(templatesData.categories)) {
        if (key !== 'home') { // æ’é™¤homeï¼Œå› ä¸ºå·²ç»ä½œä¸ºå…±äº«æ–‡å­—å¤„ç†
            menuHTML += `
                <div class="category-item ${currentInterface === key ? 'active' : ''}" onclick="switchInterface('${key}')" data-category="${key}">
                    <span class="category-icon">${category.icon}</span>
                    <span class="category-name">${category.name}</span>
                </div>
            `;
        }
    }
    
    menuContainer.innerHTML = menuHTML;
}

// åˆ‡æ¢ç•Œé¢
function switchInterface(interfaceKey) {
    // æ›´æ–°å½“å‰ç•Œé¢
    currentInterface = interfaceKey;
    
    // éšè—æ‰€æœ‰ç•Œé¢
    document.querySelectorAll('.interface-container').forEach(container => {
        container.style.display = 'none';
    });
    
    // æ›´æ–°èœå•é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.category-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-category="${interfaceKey}"]`).classList.add('active');
    
    // æ˜¾ç¤ºå¯¹åº”ç•Œé¢
    if (interfaceKey === 'home') {
        document.getElementById('textShareInterface').style.display = 'block';
    } else {
        // æ˜¾ç¤ºå¯¹åº”çš„æ¨¡æ¿ç•Œé¢
        const interfaceId = interfaceKey + 'Interface';
        const interfaceElement = document.getElementById(interfaceId);
        if (interfaceElement) {
            interfaceElement.style.display = 'block';
            renderTemplateInterface(interfaceKey);
        }
    }
    
    // å…³é—­ç§»åŠ¨ç«¯èœå•
    closeMobileSidebar();
}

// æ¸²æŸ“æ¨¡æ¿ç•Œé¢
function renderTemplateInterface(categoryKey) {
    const category = templatesData.categories[categoryKey];
    if (!category) return;
    
    // å¦‚æœæ˜¯ç³»ç»Ÿè®¾ç½®ç•Œé¢ï¼Œåˆå§‹åŒ–æ·»åŠ å†…å®¹å’Œå¯¼å…¥å¯¼å‡ºåŠŸèƒ½
    if (categoryKey === 'settings') {
        initializeAddContentFeature();
        initializeImportExportFeatures();
        return;
    }
    
    const containerId = categoryKey + 'Templates';
    const container = document.getElementById(containerId);
    if (!container) return;
    
    let html = '<div class="template-grid">';
    
    category.templates.forEach((template, index) => {
        html += `
            <div class="template-card">
                <div class="template-header">
                    <h4 class="template-title">${template.title}</h4>
                    <button onclick="copyTemplateText('${categoryKey}', ${index})" class="copy-template-btn">ğŸ“‹ å¤åˆ¶</button>
                </div>
                <div class="template-content">${template.content}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// å¤åˆ¶æ¨¡æ¿æ–‡æœ¬ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•°ï¼‰
function copyTemplateText(categoryKey, templateIndex) {
    // ä½¿ç”¨ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•°
    copyTemplateContent(categoryKey, templateIndex);
}

// åˆ‡æ¢æ¨¡æ¿ä¾§è¾¹æ ï¼ˆä»…æ‰‹æœºç«¯ä½¿ç”¨ï¼‰
function toggleTemplateSidebar() {
    if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('templateSidebar');
        sidebar.classList.toggle('mobile-open');
    }
}

// å…³é—­ç§»åŠ¨ç«¯ä¾§è¾¹æ 
function closeMobileSidebar() {
    if (window.innerWidth <= 768) {
        document.getElementById('templateSidebar').classList.remove('mobile-open');
    }
}

// çª—å£å¤§å°æ”¹å˜æ—¶çš„å¤„ç†
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // åˆ‡æ¢åˆ°æ¡Œé¢ç«¯ï¼Œå…³é—­ç§»åŠ¨ç«¯èœå•
        document.getElementById('templateSidebar').classList.remove('mobile-open');
    }
});

// æ·»åŠ ç‚¹å‡»ä¸»å†…å®¹åŒºåŸŸå…³é—­ç§»åŠ¨ç«¯èœå•çš„äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    const mainContent = document.getElementById('mainContent');
    const templateSidebar = document.getElementById('templateSidebar');
    
    // ç‚¹å‡»ä¸»å†…å®¹åŒºåŸŸå…³é—­èœå•ï¼ˆä»…åœ¨ç§»åŠ¨ç«¯å¹¶ä¸”èœå•å¼€å¯æ—¶ï¼‰
    if (mainContent) {
        mainContent.addEventListener('click', function(e) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨ç«¯å¹¶ä¸”èœå•æ˜¯å¼€å¯çŠ¶æ€
            if (window.innerWidth <= 768 && templateSidebar.classList.contains('mobile-open')) {
                // ç¡®ä¿ç‚¹å‡»çš„ä¸æ˜¯èœå•æŒ‰é’®æœ¬èº«
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                if (!mobileMenuBtn.contains(e.target)) {
                    closeMobileSidebar();
                }
            }
        });
    }
    
    // ä¹Ÿå¯ä»¥ç‚¹å‡»ä¾§è¾¹æ ä»¥å¤–çš„åŒºåŸŸå…³é—­èœå•
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768 && templateSidebar.classList.contains('mobile-open')) {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ä¾§è¾¹æ å†…éƒ¨å’Œèœå•æŒ‰é’®ï¼Œåˆ™å…³é—­èœå•
            if (!templateSidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                closeMobileSidebar();
            }
        }
    });
});

// === ä¾§è¾¹æ æœåŠ¡å™¨ä¿¡æ¯åŠŸèƒ½ ===
// å¤åˆ¶ä¾§è¾¹æ åœ°å€
function copySidebarUrl() {
    const url = '{{.server_url}}';
    console.log('ğŸ“‹ å°è¯•å¤åˆ¶ä¾§è¾¹æ åœ°å€:', url);
    
    // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        console.log('ä½¿ç”¨ Clipboard API å¤åˆ¶ä¾§è¾¹æ åœ°å€...');
        navigator.clipboard.writeText(url).then(() => {
            console.log('âœ… Clipboard API å¤åˆ¶æˆåŠŸ');
            showSidebarCopySuccess();
        }).catch((error) => {
            console.error('âŒ Clipboard API å¤±è´¥:', error);
            fallbackCopySidebarUrl(url);
        });
    } else {
        console.log('âš ï¸ Clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ fallback');
        fallbackCopySidebarUrl(url);
    }
}

// ä¾§è¾¹æ åœ°å€å¤åˆ¶çš„ fallback æ–¹æ³•
function fallbackCopySidebarUrl(url) {
    try {
        console.log('ä½¿ç”¨ execCommand å¤åˆ¶ä¾§è¾¹æ åœ°å€...');
        
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            console.log('âœ… execCommand å¤åˆ¶æˆåŠŸ');
            showSidebarCopySuccess();
        } else {
            throw new Error('execCommand è¿”å› false');
        }
    } catch (error) {
        console.error('âŒ execCommand ä¹Ÿå¤±è´¥:', error);
        showManualCopyModal(url);
    }
}

// æ˜¾ç¤ºä¾§è¾¹æ å¤åˆ¶æˆåŠŸçš„åé¦ˆ
function showSidebarCopySuccess() {
    const btn = document.querySelector('.copy-sidebar-btn');
    if (btn) {
        const originalText = btn.innerHTML;
        btn.innerHTML = 'âœ… å·²å¤åˆ¶';
        btn.style.background = 'rgba(40, 167, 69, 0.8)';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
        }, 1500);
    }
    showNotification('ğŸ“‹ æœåŠ¡å™¨åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

// å¤åˆ¶ä¸»ç•Œé¢äºŒç»´ç åŒºåŸŸçš„åœ°å€
function copyMainUrl() {
    const url = '{{.server_url}}';
    console.log('ğŸ“‹ å°è¯•å¤åˆ¶ä¸»ç•Œé¢åœ°å€:', url);
    
    // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        console.log('ä½¿ç”¨ Clipboard API å¤åˆ¶ä¸»ç•Œé¢åœ°å€...');
        navigator.clipboard.writeText(url).then(() => {
            console.log('âœ… Clipboard API å¤åˆ¶æˆåŠŸ');
            showMainCopySuccess();
        }).catch((error) => {
            console.error('âŒ Clipboard API å¤±è´¥:', error);
            fallbackCopyMainUrl(url);
        });
    } else {
        console.log('âš ï¸ Clipboard API ä¸å¯ç”¨ï¼Œä½¿ç”¨ fallback');
        fallbackCopyMainUrl(url);
    }
}

// ä¸»ç•Œé¢åœ°å€å¤åˆ¶çš„ fallback æ–¹æ³•
function fallbackCopyMainUrl(url) {
    try {
        console.log('ä½¿ç”¨ execCommand å¤åˆ¶ä¸»ç•Œé¢åœ°å€...');
        
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            console.log('âœ… execCommand å¤åˆ¶æˆåŠŸ');
            showMainCopySuccess();
        } else {
            throw new Error('execCommand è¿”å› false');
        }
    } catch (error) {
        console.error('âŒ execCommand ä¹Ÿå¤±è´¥:', error);
        showManualCopyModal(url);
    }
}

// æ˜¾ç¤ºä¸»ç•Œé¢å¤åˆ¶æˆåŠŸçš„åé¦ˆ
function showMainCopySuccess() {
    const btn = document.querySelector('.copy-url-btn');
    if (btn) {
        const originalText = btn.innerHTML;
        const originalBackground = btn.style.background;
        
        btn.innerHTML = 'âœ… å·²å¤åˆ¶';
        btn.style.background = '#218838';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = originalBackground;
        }, 1500);
    }
    showNotification('ğŸ“‹ æœåŠ¡å™¨åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
}

// === å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ ===

// åˆå§‹åŒ–å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
function initializeImportExportFeatures() {
    console.log('ğŸ”§ åˆå§‹åŒ–å¯¼å…¥å¯¼å‡ºåŠŸèƒ½...');
    
    // ç”Ÿæˆæ ç›®é€‰æ‹©åˆ—è¡¨
    generateCategoryCheckboxes();
    
    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    setupImportExportEventListeners();
}

// ç”Ÿæˆæ ç›®é€‰æ‹©åˆ—è¡¨
function generateCategoryCheckboxes() {
    const exportList = document.getElementById('exportCategoryList');
    const importList = document.getElementById('importCategoryList');
    
    if (!exportList || !importList || !templatesData) return;
    
    // åªæ˜¾ç¤ºå¯å¯¼å‡ºçš„æ ç›®ï¼ˆæ’é™¤ç³»ç»Ÿè®¾ç½®å’Œå…±äº«æ–‡å­—ï¼‰
    const allowedCategories = ['aftersale', 'express', 'presale', 'purchase', 'repair'];
    
    let checkboxHTML = '';
    
    for (const [key, category] of Object.entries(templatesData.categories)) {
        // åªæ˜¾ç¤ºæŒ‡å®šçš„æ ç›®
        if (allowedCategories.includes(key)) {
            checkboxHTML += `
                <label>
                    <input type="checkbox" value="${key}" checked>
                    <span>${category.icon} ${category.name}</span>
                </label>
            `;
        }
    }
    
    exportList.innerHTML = checkboxHTML;
    importList.innerHTML = checkboxHTML;
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupImportExportEventListeners() {
    // å¯¼å‡ºç±»å‹é€‰æ‹©
    const exportRadios = document.querySelectorAll('input[name="exportType"]');
    exportRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selection = document.getElementById('exportCategorySelection');
            selection.style.display = this.value === 'selected' ? 'block' : 'none';
        });
    });
    
    // å¯¼å…¥èŒƒå›´é€‰æ‹©
    const importRangeRadios = document.querySelectorAll('input[name="importRange"]');
    importRangeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selection = document.getElementById('importCategorySelection');
            selection.style.display = this.value === 'selected' ? 'block' : 'none';
        });
    });
}

// å¯¼å‡ºæ¨¡æ¿æ•°æ®
function exportTemplates() {
    try {
        const exportType = document.querySelector('input[name="exportType"]:checked').value;
        const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
        let url = `/api/templates/export/${exportFormat}`;
        
        if (exportType === 'selected') {
            const selectedCategories = [];
            const checkboxes = document.querySelectorAll('#exportCategoryList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });
            
            if (selectedCategories.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ ç›®');
                return;
            }
            
            url += '?categories=' + selectedCategories.join(',');
        }
        
        // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = url;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        const formatText = exportFormat === 'txt' ? 'TXTæ–‡æœ¬' : 'JSON';
        showNotification(`ğŸ“ æ•°æ®å·²å¯¼å‡ºä¸º${formatText}æ ¼å¼ï¼`);
        
    } catch (error) {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    }
}

// å¯¼å…¥æ¨¡æ¿æ•°æ®
function importTemplates() {
    try {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
            return;
        }
        
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (!['txt', 'json'].includes(fileExtension)) {
            alert('åªæ”¯æŒ TXT å’Œ JSON æ ¼å¼çš„æ–‡ä»¶');
            return;
        }
        
        const importMode = document.querySelector('input[name="importMode"]:checked').value;
        const importRange = document.querySelector('input[name="importRange"]:checked').value;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('mode', importMode);
        formData.append('format', fileExtension);
        
        if (importRange === 'selected') {
            const selectedCategories = [];
            const checkboxes = document.querySelectorAll('#importCategoryList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });
            
            if (selectedCategories.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæ ç›®');
                return;
            }
            
            formData.append('categories', selectedCategories.join(','));
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const importBtn = document.querySelector('.import-btn');
        const originalText = importBtn.innerHTML;
        importBtn.innerHTML = 'ğŸ”„ å¯¼å…¥ä¸­...';
        importBtn.disabled = true;
        
        fetch('/api/templates/import', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                let message = 'ğŸ“Š ' + result.message;
                if (result.duplicate_count && result.duplicate_count > 0) {
                    // å¦‚æœæœ‰é‡å¤é¡¹ï¼Œæ˜¾ç¤ºè­¦å‘Šæ ·å¼
                    showNotification(message, 'warning');
                } else {
                    showNotification(message);
                }
                // é‡æ–°åŠ è½½æ¨¡æ¿æ•°æ®
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('å¯¼å…¥å¤±è´¥ï¼š' + result.error);
            }
        })
        .catch(error => {
            console.error('å¯¼å…¥é”™è¯¯:', error);
            alert('å¯¼å…¥å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            importBtn.innerHTML = originalText;
            importBtn.disabled = false;
            fileInput.value = '';
        });
        
    } catch (error) {
        console.error('å¯¼å…¥é”™è¯¯:', error);
        alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
    }
}

// === æ·»åŠ å†…å®¹åŠŸèƒ½ ===

// åˆå§‹åŒ–æ·»åŠ å†…å®¹åŠŸèƒ½
function initializeAddContentFeature() {
    console.log('ğŸ”§ åˆå§‹åŒ–æ·»åŠ å†…å®¹åŠŸèƒ½...');
    console.log('ğŸ” æ£€æŸ¥ templatesData:', templatesData);
    
    // ç”Ÿæˆæ ç›®é€‰æ‹©åˆ—è¡¨
    generateCategoryOptions();
    
    // åˆå§‹åŒ–ç®¡ç†åŠŸèƒ½
    initializeManageContentFeature();
}

// ç”Ÿæˆæ ç›®é€‰æ‹©åˆ—è¡¨
function generateCategoryOptions() {
    const categorySelect = document.getElementById('categorySelect');
    if (!categorySelect || !templatesData) return;
    
    let optionsHTML = '<option value="">è¯·é€‰æ‹©æ ç›®...</option>';
    
    for (const [key, category] of Object.entries(templatesData.categories)) {
        // è·³è¿‡ç³»ç»Ÿè®¾ç½®æœ¬èº«
        if (key !== 'settings') {
            optionsHTML += `<option value="${key}">${category.icon} ${category.name}</option>`;
        }
    }
    
    categorySelect.innerHTML = optionsHTML;
}

// æ·»åŠ æ–°æ¨¡æ¿
function addNewTemplate() {
    try {
        const categoryKey = document.getElementById('categorySelect').value;
        let title = document.getElementById('templateTitle').value.trim();
        const content = document.getElementById('templateContent').value.trim();
        
        // éªŒè¯è¾“å…¥
        if (!categoryKey) {
            alert('è¯·é€‰æ‹©æ ç›®');
            return;
        }
        
        // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å…¥é»˜è®¤å€¼
        if (!title) {
            title = 'æœªè¯´æ˜';
            // åŒæ—¶æ›´æ–°ç•Œé¢æ˜¾ç¤º
            document.getElementById('templateTitle').value = title;
        }
        
        if (!content) {
            alert('è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
            document.getElementById('templateContent').focus();
            return;
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const addBtn = document.querySelector('.add-btn');
        const originalText = addBtn.innerHTML;
        addBtn.innerHTML = 'ğŸ”„ æ·»åŠ ä¸­...';
        addBtn.disabled = true;
        
        // å‘é€è¯·æ±‚
        fetch(`/api/templates/category/${categoryKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: title,
                content: content
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                if (result.is_duplicate) {
                    showNotification('âš ï¸ ' + result.message);
                } else {
                    showNotification('âœ… ' + result.message);
                }
                clearAddForm();
                // æ·»åŠ æˆåŠŸååœç•™åœ¨å½“å‰é¡µé¢ï¼Œæ— éœ€è·³è½¬
            } else {
                alert('æ·»åŠ å¤±è´¥ï¼š' + result.error);
            }
        })
        .catch(error => {
            console.error('æ·»åŠ æ¨¡æ¿é”™è¯¯:', error);
            alert('æ·»åŠ å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
        })
        .finally(() => {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
        });
        
    } catch (error) {
        console.error('æ·»åŠ æ¨¡æ¿é”™è¯¯:', error);
        alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
    }
}

// æ¸…ç©ºè¡¨å•
function clearAddForm() {
    document.getElementById('categorySelect').value = '';
    document.getElementById('templateTitle').value = '';
    document.getElementById('templateContent').value = '';
}

// === ç®¡ç†ç°æœ‰å†…å®¹åŠŸèƒ½ ===

// åˆå§‹åŒ–ç®¡ç†åŠŸèƒ½
function initializeManageContentFeature() {
    console.log('ğŸ”§ åˆå§‹åŒ–ç®¡ç†å†…å®¹åŠŸèƒ½...');
    console.log('ğŸ” æ£€æŸ¥ templatesData:', templatesData);
    
    // ç”Ÿæˆç®¡ç†æ ç›®é€‰æ‹©åˆ—è¡¨
    generateManageCategoryOptions();
}

// ç”Ÿæˆç®¡ç†æ ç›®é€‰æ‹©åˆ—è¡¨
function generateManageCategoryOptions() {
    const manageCategorySelect = document.getElementById('manageCategorySelect');
    if (!manageCategorySelect || !templatesData) return;
    
    let optionsHTML = '<option value="">è¯·é€‰æ‹©æ ç›®...</option>';
    
    for (const [key, category] of Object.entries(templatesData.categories)) {
        // è·³è¿‡ç³»ç»Ÿè®¾ç½®æœ¬èº«
        if (key !== 'settings') {
            optionsHTML += `<option value="${key}">${category.icon} ${category.name}</option>`;
        }
    }
    
    manageCategorySelect.innerHTML = optionsHTML;
}

// åŠ è½½æ ç›®æ¨¡æ¿
function loadCategoryTemplates() {
    const categoryKey = document.getElementById('manageCategorySelect').value;
    const templatesList = document.getElementById('templatesList');
    const categoryDeleteContainer = document.getElementById('categoryDeleteContainer');
    
    if (!categoryKey) {
        templatesList.innerHTML = '<div class="no-selection">è¯·é€‰æ‹©æ ç›®æŸ¥çœ‹å…¶ä¸­çš„æ¨¡æ¿</div>';
        categoryDeleteContainer.style.display = 'none';
        return;
    }
    
    const category = templatesData.categories[categoryKey];
    if (!category || !category.templates || category.templates.length === 0) {
        templatesList.innerHTML = '<div class="no-selection">è¯¥æ ç›®ä¸‹æš‚æ— æ¨¡æ¿</div>';
        categoryDeleteContainer.style.display = 'none';
        return;
    }
    
    // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼Œå¹¶æ›´æ–°æŒ‰é’®æ–‡å­—
    categoryDeleteContainer.style.display = 'block';
    const categoryDeleteBtn = categoryDeleteContainer.querySelector('.clear-category-btn');
    categoryDeleteBtn.innerHTML = `ğŸ—‘ï¸ åˆ é™¤â€œ${category.name}â€æ ç›®æ‰€æœ‰å†…å®¹ (${category.templates.length}ä¸ª)`;
    
    let html = '';
    category.templates.forEach((template, index) => {
        html += `
            <div class="template-item" id="template-${categoryKey}-${index}">
                <div class="template-item-header">
                    <h4 class="template-item-title">${template.title}</h4>
                    <div class="template-item-actions">
                        <button class="copy-btn" onclick="copyTemplateContent('${categoryKey}', ${index})">
                            ğŸ“‹ å¤åˆ¶
                        </button>
                        <button class="edit-btn" onclick="editTemplate('${categoryKey}', ${index})">
                            âœï¸ ç¼–è¾‘
                        </button>
                        <button class="delete-btn" onclick="deleteTemplate('${categoryKey}', ${index})">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>
                    </div>
                </div>
                <div class="template-item-content">${template.content}</div>
            </div>
        `;
    });
    
    templatesList.innerHTML = html;
}

// æ¸…ç©ºæ‰€æœ‰æ ç›®çš„æ‰€æœ‰æ¨¡æ¿
function clearAllTemplates() {
    if (!templatesData || !templatesData.categories) {
        alert('æ¨¡æ¿æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    // ç»Ÿè®¡æ€»æ¨¡æ¿æ•°é‡
    let totalTemplates = 0;
    const allowedCategories = ['aftersale', 'express', 'presale', 'purchase', 'repair'];
    
    for (const [key, category] of Object.entries(templatesData.categories)) {
        if (allowedCategories.includes(key) && category.templates) {
            totalTemplates += category.templates.length;
        }
    }
    
    if (totalTemplates === 0) {
        alert('æ²¡æœ‰å¯æ¸…ç©ºçš„æ¨¡æ¿å†…å®¹');
        return;
    }
    
    const confirmMessage = `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ ç›®çš„æ‰€æœ‰æ¨¡æ¿å—ï¼Ÿ\n\nå°†åˆ é™¤ ${totalTemplates} ä¸ªæ¨¡æ¿ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const clearAllBtn = document.querySelector('.clear-all-btn');
    const originalText = clearAllBtn.innerHTML;
    clearAllBtn.innerHTML = 'ğŸ”„ æ¸…ç©ºä¸­...';
    clearAllBtn.disabled = true;
    
    // æ¸…ç©ºæ‰€æœ‰å…è®¸çš„æ ç›®æ¨¡æ¿
    const updatedTemplates = { ...templatesData };
    
    for (const categoryKey of allowedCategories) {
        if (updatedTemplates.categories[categoryKey]) {
            updatedTemplates.categories[categoryKey].templates = [];
        }
    }
    
    // å‘é€æ›´æ–°è¯·æ±‚
    fetch('/api/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedTemplates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('ğŸ—‘ï¸ æ‰€æœ‰æ¨¡æ¿å·²æ¸…ç©ºï¼');
            // é‡æ–°åŠ è½½æ¨¡æ¿æ•°æ®
            setTimeout(() => {
                initializeTemplates();
            }, 1000);
        } else {
            alert('æ¸…ç©ºå¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('æ¸…ç©ºé”™è¯¯:', error);
        alert('æ¸…ç©ºå¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        clearAllBtn.innerHTML = originalText;
        clearAllBtn.disabled = false;
    });
}

// æ¸…ç©ºå½“å‰é€‰ä¸­æ ç›®çš„æ‰€æœ‰æ¨¡æ¿
function clearCategoryTemplates() {
    const categoryKey = document.getElementById('manageCategorySelect').value;
    
    if (!categoryKey) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ç›®');
        return;
    }
    
    const category = templatesData.categories[categoryKey];
    if (!category || !category.templates || category.templates.length === 0) {
        alert('è¯¥æ ç›®ä¸‹æ²¡æœ‰æ¨¡æ¿å¯åˆ é™¤');
        return;
    }
    
    const confirmMessage = `ç¡®å®šè¦åˆ é™¤"${category.name}"æ ç›®ä¸‹çš„æ‰€æœ‰ ${category.templates.length} ä¸ªæ¨¡æ¿å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const clearCategoryBtn = document.querySelector('.clear-category-btn');
    const originalText = clearCategoryBtn.innerHTML;
    clearCategoryBtn.innerHTML = 'ğŸ”„ åˆ é™¤ä¸­...';
    clearCategoryBtn.disabled = true;
    
    // æ¸…ç©ºå½“å‰æ ç›®æ¨¡æ¿
    const updatedTemplates = { ...templatesData };
    updatedTemplates.categories[categoryKey].templates = [];
    
    // å‘é€æ›´æ–°è¯·æ±‚
    fetch('/api/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedTemplates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification(`ğŸ—‘ï¸ "${category.name}"æ ç›®æ¨¡æ¿å·²æ¸…ç©ºï¼`);
            // é‡æ–°åŠ è½½æ¨¡æ¿æ•°æ®
            setTimeout(() => {
                initializeTemplates();
                // é‡æ–°åŠ è½½å½“å‰æ ç›®
                setTimeout(() => {
                    document.getElementById('manageCategorySelect').value = categoryKey;
                    loadCategoryTemplates();
                }, 500);
            }, 1000);
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('åˆ é™¤é”™è¯¯:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        clearCategoryBtn.innerHTML = originalText;
        clearCategoryBtn.disabled = false;
    });
}

// ç¼–è¾‘æ¨¡æ¿
function editTemplate(categoryKey, templateIndex) {
    const templateItem = document.getElementById(`template-${categoryKey}-${templateIndex}`);
    const template = templatesData.categories[categoryKey].templates[templateIndex];
    
    templateItem.classList.add('editing');
    
    const editFormHTML = `
        <div class="edit-form">
            <div class="form-group">
                <label>æ¨¡æ¿æ ‡é¢˜ï¼š</label>
                <input type="text" id="edit-title-${categoryKey}-${templateIndex}" class="form-input" value="${template.title}">
            </div>
            <div class="form-group">
                <label>æ¨¡æ¿å†…å®¹ï¼š</label>
                <textarea id="edit-content-${categoryKey}-${templateIndex}" class="form-textarea" rows="4">${template.content}</textarea>
            </div>
            <div class="form-actions">
                <button class="action-btn save-btn" onclick="saveTemplate('${categoryKey}', ${templateIndex})">
                    âœ… ä¿å­˜
                </button>
                <button class="action-btn cancel-btn" onclick="cancelEdit('${categoryKey}', ${templateIndex})">
                    âŒ å–æ¶ˆ
                </button>
            </div>
        </div>
    `;
    
    templateItem.innerHTML = editFormHTML;
}

// ä¿å­˜æ¨¡æ¿
function saveTemplate(categoryKey, templateIndex) {
    const titleInput = document.getElementById(`edit-title-${categoryKey}-${templateIndex}`);
    const contentInput = document.getElementById(`edit-content-${categoryKey}-${templateIndex}`);
    
    let newTitle = titleInput.value.trim();
    const newContent = contentInput.value.trim();
    
    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œè‡ªåŠ¨å¡«å…¥é»˜è®¤å€¼
    if (!newTitle) {
        newTitle = 'æœªè¯´æ˜';
        // åŒæ—¶æ›´æ–°ç•Œé¢æ˜¾ç¤º
        titleInput.value = newTitle;
    }
    
    if (!newContent) {
        alert('è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
        contentInput.focus();
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const saveBtn = document.querySelector(`#template-${categoryKey}-${templateIndex} .save-btn`);
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'ğŸ”„ ä¿å­˜ä¸­...';
    saveBtn.disabled = true;
    
    // æ›´æ–°æ•°æ®
    const updatedTemplates = { ...templatesData };
    updatedTemplates.categories[categoryKey].templates[templateIndex] = {
        title: newTitle,
        content: newContent
    };
    
    // å‘é€æ›´æ–°è¯·æ±‚
    fetch('/api/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedTemplates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('âœ… æ¨¡æ¿æ›´æ–°æˆåŠŸï¼');
            // é‡æ–°åŠ è½½å½“å‰æ ç›®æ¨¡æ¿åˆ—è¡¨
            templatesData = result.templates_data || updatedTemplates;
            loadCategoryTemplates();
        } else {
            alert('æ›´æ–°å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('æ›´æ–°æ¨¡æ¿é”™è¯¯:', error);
        alert('æ›´æ–°å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// å–æ¶ˆç¼–è¾‘
function cancelEdit(categoryKey, templateIndex) {
    // é‡æ–°åŠ è½½æ ç›®æ¨¡æ¿
    loadCategoryTemplates();
}

// åˆ é™¤æ¨¡æ¿
function deleteTemplate(categoryKey, templateIndex) {
    const template = templatesData.categories[categoryKey].templates[templateIndex];
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿â€œ${template.title}â€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const deleteBtn = document.querySelector(`#template-${categoryKey}-${templateIndex} .delete-btn`);
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = 'ğŸ”„ åˆ é™¤ä¸­...';
    deleteBtn.disabled = true;
    
    // æ›´æ–°æ•°æ®
    const updatedTemplates = { ...templatesData };
    updatedTemplates.categories[categoryKey].templates.splice(templateIndex, 1);
    
    // å‘é€æ›´æ–°è¯·æ±‚
    fetch('/api/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedTemplates)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('ğŸ—‘ï¸ æ¨¡æ¿åˆ é™¤æˆåŠŸï¼');
            // é‡æ–°åŠ è½½å½“å‰æ ç›®æ¨¡æ¿åˆ—è¡¨
            templatesData = result.templates_data || updatedTemplates;
            loadCategoryTemplates();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('åˆ é™¤æ¨¡æ¿é”™è¯¯:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

// å¤åˆ¶æ¨¡æ¿å†…å®¹ï¼ˆç»Ÿä¸€çš„ã€æ”¹è¿›çš„ç‰ˆæœ¬ï¼‰
function copyTemplateContent(categoryKey, templateIndex) {
    console.log('ğŸ“‹ å¤åˆ¶å‡½æ•°è¢«è°ƒç”¨ï¼Œå‚æ•°:', categoryKey, templateIndex);
    
    // æ£€æŸ¥æ•°æ®æ˜¯å¦å­˜åœ¨
    if (!templatesData || !templatesData.categories) {
        console.error('æ¨¡æ¿æ•°æ®ä¸å­˜åœ¨ï¼ŒtemplatesData:', templatesData);
        alert('æ¨¡æ¿æ•°æ®ä¸å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }
    
    if (!templatesData.categories[categoryKey]) {
        console.error('æŒ‡å®šçš„æ¨¡æ¿åˆ†ç±»ä¸å­˜åœ¨:', categoryKey);
        alert('æŒ‡å®šçš„æ¨¡æ¿åˆ†ç±»ä¸å­˜åœ¨');
        return;
    }
    
    const template = templatesData.categories[categoryKey].templates[templateIndex];
    if (!template) {
        console.error('æŒ‡å®šçš„æ¨¡æ¿ä¸å­˜åœ¨:', templateIndex);
        alert('æŒ‡å®šçš„æ¨¡æ¿ä¸å­˜åœ¨');
        return;
    }
    
    const textToCopy = template.content;
    console.log('è¦å¤åˆ¶çš„å†…å®¹:', textToCopy);
    
    // æ‰¾åˆ°å¤åˆ¶æŒ‰é’®ï¼ˆå¯èƒ½æ‰¾ä¸åˆ°ï¼Œä½†ä¸å½±å“å¤åˆ¶åŠŸèƒ½ï¼‰
    const copyBtn = document.querySelector(`#template-${categoryKey}-${templateIndex} .copy-btn`);
    console.log('æ‰¾åˆ°çš„å¤åˆ¶æŒ‰é’®:', copyBtn);
    
    // ä¼˜å…ˆå°è¯•ç°ä»£å¤åˆ¶æ–¹æ³•
    if (navigator.clipboard && navigator.clipboard.writeText) {
        console.log('ä½¿ç”¨ Clipboard API å¤åˆ¶...');
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                console.log('Clipboard API å¤åˆ¶æˆåŠŸ');
                showCopyFeedback(copyBtn, 'âœ… å·²å¤åˆ¶');
                showNotification('ğŸ“‹ æ¨¡æ¿å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            })
            .catch((error) => {
                console.error('Clipboard API å¤åˆ¶å¤±è´¥:', error);
                legacyCopy(textToCopy, copyBtn);
            });
    } else {
        console.log('æµè§ˆå™¨ä¸æ”¯æŒ Clipboard APIï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•');
        legacyCopy(textToCopy, copyBtn);
    }
}

// ä¼ ç»Ÿå¤åˆ¶æ–¹æ³•
function legacyCopy(text, copyBtn) {
    try {
        console.log('ä½¿ç”¨ execCommand å¤åˆ¶...');
        
        // åˆ›å»ºä¸´æ—¶ textarea
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        
        // é€‰æ‹©å¹¶å¤åˆ¶
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
            console.log('execCommand å¤åˆ¶æˆåŠŸ');
            showCopyFeedback(copyBtn, 'âœ… å·²å¤åˆ¶');
            showNotification('ğŸ“‹ æ¨¡æ¿å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } else {
            throw new Error('execCommand è¿”å› false');
        }
    } catch (error) {
        console.error('execCommand å¤åˆ¶ä¹Ÿå¤±è´¥:', error);
        // æœ€åçš„ fallbackï¼šæ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†
        showManualCopyModal(text);
    }
}

// æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„è§†è§‰åé¦ˆ
function showCopyFeedback(button, successText) {
    if (!button) return;
    
    const originalText = button.innerHTML;
    const originalBackground = button.style.background;
    
    button.innerHTML = successText;
    button.style.background = '#28a745';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = originalBackground;
    }, 2000);
}

// æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†
function showManualCopyModal(text) {
    console.log('æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†');
    
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        padding: 25px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        overflow-y: auto;
    `;
    
    dialog.innerHTML = `
        <h3 style="margin: 0 0 15px 0; color: #333;">ğŸ“‹ è¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹å†…å®¹</h3>
        <textarea readonly style="width: 100%; height: 150px; border: 1px solid #ddd; padding: 10px; border-radius: 5px; font-family: inherit; resize: none;">${text}</textarea>
        <div style="margin-top: 15px; text-align: right;">
            <button onclick="this.closest('.manual-copy-modal').remove()" 
                    style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                å…³é—­
            </button>
        </div>
    `;
    
    modal.className = 'manual-copy-modal';
    modal.appendChild(dialog);
    document.body.appendChild(modal);
    
    // è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬æ–¹ä¾¿æ‰‹åŠ¨å¤åˆ¶
    const textarea = dialog.querySelector('textarea');
    setTimeout(() => {
        textarea.focus();
        textarea.select();
    }, 100);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// === æ–‡ä»¶å®æ—¶ä¼ è¾“åŠŸèƒ½ ===

// åˆå§‹åŒ–æ–‡ä»¶ä¼ è¾“åŠŸèƒ½
function initializeFileUpload() {
    console.log('ğŸ“¤ åˆå§‹åŒ–æ–‡ä»¶å®æ—¶ä¼ è¾“åŠŸèƒ½...');
    
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    
    if (!fileInput || !uploadArea) {
        console.log('âš ï¸ æ–‡ä»¶ä¼ è¾“å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
    fileInput.addEventListener('change', handleFileSelect);
    
    // æ‹–æ‹½äº‹ä»¶
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleFileDrop);
    uploadArea.addEventListener('dragleave', handleDragLeave);
    
    console.log('âœ… æ–‡ä»¶ä¼ è¾“åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
}

// æ˜¾ç¤ºä¼ è¾“æ¨¡æ€æ¡†
function showUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'flex';
        clearFileSelection();
    }
}

// å…³é—­ä¼ è¾“æ¨¡æ€æ¡†
function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.style.display = 'none';
        clearFileSelection();
    }
}

// æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
function clearFileSelection() {
    const fileInput = document.getElementById('fileInput');
    const selectedFiles = document.getElementById('selectedFiles');
    const uploadBtn = document.getElementById('uploadSubmitBtn');
    
    if (fileInput) fileInput.value = '';
    if (selectedFiles) selectedFiles.style.display = 'none';
    if (uploadBtn) uploadBtn.disabled = true;
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0) {
        displaySelectedFiles(files);
    }
}

// å¤„ç†æ‹–æ‹½äº‹ä»¶
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
}

function handleFileDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        // è®¾ç½®åˆ°file input
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.files = files;
            displaySelectedFiles(files);
        }
    }
}

// æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶
function displaySelectedFiles(files) {
    const selectedFilesDiv = document.getElementById('selectedFiles');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadSubmitBtn');
    
    if (!selectedFilesDiv || !fileList || !uploadBtn) return;
    
    // æ¸…ç©ºåˆ—è¡¨
    fileList.innerHTML = '';
    
    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
    Array.from(files).forEach(file => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span class="file-name">ğŸ“„ ${file.name}</span>
            <span class="file-size">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
        `;
        fileList.appendChild(li);
    });
    
    selectedFilesDiv.style.display = 'block';
    uploadBtn.disabled = false;
}

// å‘é€æ–‡ä»¶
function sendFiles() {
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadSubmitBtn');
    
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }
    
    const files = Array.from(fileInput.files);
    const originalText = uploadBtn.innerHTML;
    
    uploadBtn.innerHTML = 'ğŸ“‹ å‘é€ä¸­...';
    uploadBtn.disabled = true;
    
    sendFilesSequentially(files, 0, originalText);
}

// === æ–‡ä»¶ä¼ è¾“é€šçŸ¥å¤„ç† ===

// å­˜å‚¨æ¥æ”¶åˆ°çš„æ–‡ä»¶æ•°æ®
let receivedFilesData = new Map();

// æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ–‡ä»¶é€šçŸ¥
function showIncomingFileNotification(fileData) {
    console.log('ğŸ“ æ˜¾ç¤ºæ–‡ä»¶æ¥æ”¶é€šçŸ¥:', fileData);
    
    // å­˜å‚¨æ–‡ä»¶æ•°æ®ä¾›åç»­ä¸‹è½½ä½¿ç”¨
    receivedFilesData.set(fileData.file_id, fileData);
    
    // æ˜¾ç¤ºæ–‡ä»¶é€šçŸ¥åŒºåŸŸ
    const notificationsArea = document.getElementById('fileNotifications');
    const notificationsList = document.getElementById('fileNotificationsList');
    
    if (!notificationsArea || !notificationsList) {
        console.log('âš ï¸ æ–‡ä»¶é€šçŸ¥åŒºåŸŸæœªæ‰¾åˆ°');
        return;
    }
    
    // æ˜¾ç¤ºé€šçŸ¥åŒºåŸŸ
    notificationsArea.style.display = 'block';
    
    // åˆ›å»ºæ–‡ä»¶é€šçŸ¥å¡ç‰‡
    const notificationCard = document.createElement('div');
    notificationCard.className = 'file-notification-card';
    notificationCard.id = `file-notification-${fileData.file_id}`;
    
    notificationCard.innerHTML = `
        <div class="file-notification-header">
            <div class="file-info">
                <div class="file-name">ğŸ“„ ${fileData.filename}</div>
                <div class="file-meta">
                    <span class="file-size">${fileData.size_mb} MB</span>
                    <span class="file-time">â° ${fileData.send_time}</span>
                    <span class="file-sender">ğŸ‘¤ æ¥è‡ª ${fileData.sender_ip}</span>
                </div>
            </div>
            <div class="file-status">
                <span class="status-waiting">ç­‰å¾…æ¥æ”¶...</span>
            </div>
        </div>
        <div class="file-actions">
            <button onclick="acceptFile('${fileData.file_id}')" class="accept-btn">âœ… æ¥æ”¶</button>
            <button onclick="rejectFile('${fileData.file_id}')" class="reject-btn">âŒ æ‹’ç»</button>
        </div>
    `;
    
    // æ·»åŠ åˆ°é€šçŸ¥åˆ—è¡¨é¡¶éƒ¨
    notificationsList.insertBefore(notificationCard, notificationsList.firstChild);
    
    // æ˜¾ç¤ºé€šçŸ¥æç¤º
    showNotification(`ğŸ“ æ”¶åˆ°æ–°æ–‡ä»¶: ${fileData.filename}`, 'info');
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°é€šçŸ¥åŒºåŸŸ
    notificationCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// æ¥æ”¶æ–‡ä»¶ - å®é™…ä¸‹è½½æ–‡ä»¶
function acceptFile(fileId) {
    console.log('âœ… ç”¨æˆ·é€‰æ‹©æ¥æ”¶æ–‡ä»¶:', fileId);
    
    const notificationCard = document.getElementById(`file-notification-${fileId}`);
    if (!notificationCard) return;
    
    // è·å–æ–‡ä»¶æ•°æ®
    const fileData = receivedFilesData.get(fileId);
    if (!fileData) {
        console.error('âŒ æ–‡ä»¶æ•°æ®æœªæ‰¾åˆ°:', fileId);
        showNotification('âŒ æ–‡ä»¶æ•°æ®ä¸¢å¤±ï¼Œæ— æ³•ä¸‹è½½', 'error');
        return;
    }
    
    // æ›´æ–°çŠ¶æ€
    const statusElement = notificationCard.querySelector('.file-status span');
    const buttons = notificationCard.querySelectorAll('.file-actions button');
    
    statusElement.textContent = 'æ­£åœ¨ä¸‹è½½...';
    statusElement.className = 'status-downloading';
    
    // ç¦ç”¨æŒ‰é’®
    buttons.forEach(btn => btn.disabled = true);
    
    try {
        // è§£ç Base64æ•°æ®å¹¶åˆ›å»ºBlob
        const byteCharacters = atob(fileData.data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: fileData.type || 'application/octet-stream' });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
        const downloadUrl = URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = downloadUrl;
        downloadLink.download = fileData.filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        // é‡Šæ”¾å†…å­˜
        URL.revokeObjectURL(downloadUrl);
        
        // æ›´æ–°çŠ¶æ€ä¸ºå·²æ¥æ”¶
        statusElement.textContent = 'âœ… å·²ä¸‹è½½';
        statusElement.className = 'status-received';
        
        // å‘é€æ¥æ”¶ç¡®è®¤
        fetch('/file_received', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: fileId,
                mode: getTransferMode() // è·å–å½“å‰é€‰æ‹©çš„ä¼ è¾“æ¨¡å¼
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('âœ… æ¥æ”¶ç¡®è®¤å·²å‘é€');
            } else {
                console.warn('âš ï¸ æ¥æ”¶ç¡®è®¤å‘é€å¤±è´¥:', result.error);
            }
        })
        .catch(error => {
            console.error('âŒ å‘é€æ¥æ”¶ç¡®è®¤å¤±è´¥:', error);
        });
        
        showNotification('âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼');
        
        // 3ç§’åç§»é™¤é€šçŸ¥
        setTimeout(() => {
            if (notificationCard.parentNode) {
                notificationCard.parentNode.removeChild(notificationCard);
                // æ¸…ç†å­˜å‚¨çš„æ–‡ä»¶æ•°æ®
                receivedFilesData.delete(fileId);
            }
            
            // å¦‚æœæ²¡æœ‰æ›´å¤šé€šçŸ¥ï¼Œéšè—é€šçŸ¥åŒºåŸŸ
            const notificationsList = document.getElementById('fileNotificationsList');
            if (notificationsList && notificationsList.children.length === 0) {
                const notificationsArea = document.getElementById('fileNotifications');
                if (notificationsArea) {
                    notificationsArea.style.display = 'none';
                }
            }
        }, 3000);
        
    } catch (error) {
        console.error('âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥:', error);
        statusElement.textContent = 'âŒ ä¸‹è½½å¤±è´¥';
        statusElement.className = 'status-error';
        buttons.forEach(btn => btn.disabled = false);
        showNotification('âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
    }
}

// è·å–å½“å‰é€‰æ‹©çš„ä¼ è¾“æ¨¡å¼
function getTransferMode() {
    const modeRadio = document.querySelector('input[name="transferMode"]:checked');
    return modeRadio ? modeRadio.value : 'exclusive';
}

// æ‹’ç»æ–‡ä»¶
function rejectFile(fileId) {
    console.log('âŒ ç”¨æˆ·é€‰æ‹©æ‹’ç»æ–‡ä»¶:', fileId);
    
    const notificationCard = document.getElementById(`file-notification-${fileId}`);
    if (!notificationCard) return;
    
    // æ›´æ–°çŠ¶æ€
    const statusElement = notificationCard.querySelector('.file-status span');
    const buttons = notificationCard.querySelectorAll('.file-actions button');
    
    statusElement.textContent = 'âŒ å·²æ‹’ç»';
    statusElement.className = 'status-rejected';
    
    // ç¦ç”¨æŒ‰é’®
    buttons.forEach(btn => btn.disabled = true);
    
    showNotification('âŒ å·²æ‹’ç»æ–‡ä»¶');
    
    // 3ç§’åç§»é™¤é€šçŸ¥å¡ç‰‡
    setTimeout(() => {
        if (notificationCard.parentNode) {
            notificationCard.parentNode.removeChild(notificationCard);
        }
        
        // å¦‚æœæ²¡æœ‰æ›´å¤šé€šçŸ¥ï¼Œéšè—é€šçŸ¥åŒºåŸŸ
        const notificationsList = document.getElementById('fileNotificationsList');
        if (notificationsList && notificationsList.children.length === 0) {
            const notificationsArea = document.getElementById('fileNotifications');
            if (notificationsArea) {
                notificationsArea.style.display = 'none';
            }
        }
    }, 3000);
}

// å¤„ç†æ–‡ä»¶æ¥æ”¶é€šçŸ¥
function handleFileReceivedNotification(data) {
    console.log('ğŸ“‹ å¤„ç†æ–‡ä»¶æ¥æ”¶é€šçŸ¥:', data);
    
    const notificationCard = document.getElementById(`file-notification-${data.file_id}`);
    if (!notificationCard) return;
    
    const statusElement = notificationCard.querySelector('.file-status span');
    const buttons = notificationCard.querySelectorAll('.file-actions button');
    
    if (data.mode === 'exclusive') {
        // ç‹¬å æ¨¡å¼ï¼šå…¶ä»–äººä¸èƒ½å†æ¥æ”¶
        statusElement.textContent = 'âš ï¸ å·²è¢«ä»–äººæ¥æ”¶';
        statusElement.className = 'status-taken';
        buttons.forEach(btn => btn.disabled = true);
        
        showNotification(`âš ï¸ æ–‡ä»¶å·²è¢« ${data.receiver_ip} æ¥æ”¶`, 'warning');
        
        // 5ç§’åç§»é™¤é€šçŸ¥
        setTimeout(() => {
            if (notificationCard.parentNode) {
                notificationCard.parentNode.removeChild(notificationCard);
            }
        }, 5000);
    }
    // å…±äº«æ¨¡å¼ä¸‹ä¸åšç‰¹æ®Šå¤„ç†ï¼Œå…è®¸å¤šäººæ¥æ”¶
}

// é¡ºåºå‘é€æ–‡ä»¶
function sendFilesSequentially(files, index, originalText) {
    if (index >= files.length) {
        const uploadBtn = document.getElementById('uploadSubmitBtn');
        if (uploadBtn) {
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false;
        }
        closeUploadModal();
        showNotification('âœ… æ‰€æœ‰æ–‡ä»¶å·²å‘é€ç»™å±€åŸŸç½‘è®¾å¤‡ï¼');
        return;
    }
    
    const file = files[index];
    const formData = new FormData();
    formData.append('file', file);
    
    console.log(`ğŸ“¤ å‘é€æ–‡ä»¶ ${index + 1}/${files.length}: ${file.name}`);
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            console.log(`âœ… æ–‡ä»¶å‘é€æˆåŠŸ: ${file.name}`);
            sendFilesSequentially(files, index + 1, originalText);
        } else {
            throw new Error(result.error || 'å‘é€å¤±è´¥');
        }
    })
    .catch(error => {
        console.error(`âŒ æ–‡ä»¶å‘é€å¤±è´¥: ${file.name}`, error);
        alert(`æ–‡ä»¶ "${file.name}" å‘é€å¤±è´¥: ${error.error || error.message || 'æœªçŸ¥é”™è¯¯'}`);
        
        const uploadBtn = document.getElementById('uploadSubmitBtn');
        if (uploadBtn) {
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false;
        }
    });
}

// åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
function refreshFilesList() {
    fetch('/files')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                updateFilesDisplay(result.files);
            }
        })
        .catch(error => {
            console.error('åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        });
}

// æ›´æ–°æ–‡ä»¶æ˜¾ç¤º
function updateFilesDisplay(files) {
    const filesList = document.getElementById('filesList');
    if (!filesList) return;
    
    if (files.length === 0) {
        filesList.innerHTML = '<div class="no-files">è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</div>';
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const originalName = file.filename.includes('_') ? file.filename.split('_', 1)[1] : file.filename;
        html += `
            <div class="file-item" data-filename="${file.filename}">
                <div class="file-info">
                    <div class="file-name" title="${file.filename}">
                        ğŸ“„ ${originalName}
                    </div>
                    <div class="file-meta">
                        <span class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                        <span class="file-time">â° ${file.upload_time}</span>
                    </div>
                </div>
                <div class="file-actions">
                    <button onclick="downloadFile('${file.filename}')" class="download-btn">â¬‡ï¸ ä¸‹è½½</button>
                    <button onclick="deleteFile('${file.filename}')" class="delete-btn">ğŸ—‘ï¸ åˆ é™¤</button>
                </div>
            </div>
        `;
    });
    
    filesList.innerHTML = html;
}

// ä¸‹è½½æ–‡ä»¶
function downloadFile(filename) {
    window.open(`/download/${filename}`, '_blank');
}

// åˆ é™¤æ–‡ä»¶
function deleteFile(filename) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
        return;
    }
    
    fetch(`/delete_file/${filename}`, {
        method: 'POST'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            showNotification('âœ… æ–‡ä»¶åˆ é™¤æˆåŠŸ');
            // ä» UI ä¸­ç§»é™¤æ–‡ä»¶é¡¹
            const fileItem = document.querySelector(`[data-filename="${filename}"]`);
            if (fileItem) {
                fileItem.remove();
            }
            // å¦‚æœæ²¡æœ‰WebSocketè¿æ¥ï¼Œæ‰‹åŠ¨åˆ·æ–°
            if (!isConnected) {
                refreshFilesList();
            }
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(error => {
        console.error('åˆ é™¤æ–‡ä»¶é”™è¯¯:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + (error.error || error.message || 'æœªçŸ¥é”™è¯¯'));
    });
}
</script>
</body>
</html>
