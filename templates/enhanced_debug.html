<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆæ™ºèƒ½æ£€æµ‹è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            min-height: 100vh;
        }
        
        .debug-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .debug-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .debug-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .test-btn {
            background: linear-gradient(45deg, #27ae60, #219653);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .status-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        h1, h2 {
            margin-top: 0;
        }
        
        .clear-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .result-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border-left: 4px solid #3498db;
        }
        
        .success-box {
            border-left: 4px solid #27ae60;
        }
        
        .error-box {
            border-left: 4px solid #e74c3c;
        }
        
        .warning-box {
            border-left: 4px solid #f39c12;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .step {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            flex: 1;
            margin: 0 5px;
        }
        
        .step.active {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid #3498db;
        }
        
        .step.completed {
            background: rgba(39, 174, 96, 0.3);
            border: 2px solid #27ae60;
        }
        
        .ip-input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin: 8px;
            width: 200px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¢å¼ºç‰ˆæ™ºèƒ½æ£€æµ‹è°ƒè¯•å·¥å…· v1.0.8</h1>
    
    <div class="debug-card">
        <h2>ğŸ“ å½“å‰è®¿é—®ä¿¡æ¯</h2>
        <div class="status-info">
            <div><strong>ğŸŒ å½“å‰URL:</strong> <span id="currentURL">åŠ è½½ä¸­...</span></div>
            <div><strong>ğŸ  å½“å‰ä¸»æœº(Host):</strong> <span id="currentHost">åŠ è½½ä¸­...</span></div>
            <div><strong>ğŸ“Š åè®®:</strong> <span id="currentProtocol">åŠ è½½ä¸­...</span></div>
            <div><strong>ğŸšª ç«¯å£:</strong> <span id="currentPort">åŠ è½½ä¸­...</span></div>
        </div>
    </div>
    
    <div class="debug-card">
        <h2>ğŸ”§ è°ƒè¯•å·¥å…·</h2>
        <div class="result-box">
            <h3>APIè°ƒç”¨æµ‹è¯•</h3>
            <button class="debug-btn" onclick="testAPICall()">ğŸ“¡ æµ‹è¯•å±€åŸŸç½‘æ£€æµ‹API</button>
            
            <h3>æ‰‹åŠ¨IPæµ‹è¯•</h3>
            <input type="text" id="manualIP" class="ip-input" placeholder="è¾“å…¥IPåœ°å€ï¼Œä¾‹å¦‚ï¼š192.168.3.100">
            <button class="test-btn" onclick="testManualIP()">ğŸ§ª æµ‹è¯•æŒ‡å®šIP</button>
            
            <h3>å¼ºåˆ¶æ˜¾ç¤ºæµ‹è¯•</h3>
            <button class="test-btn" onclick="forceShowPrompt()">ğŸ”” å¼ºåˆ¶æ˜¾ç¤ºæç¤ºæ¡†</button>
            
            <h3>è°ƒè¯•æ“ä½œ</h3>
            <button class="debug-btn" onclick="showAllFunctions()">ğŸ“‹ æ˜¾ç¤ºæ‰€æœ‰å‡½æ•°</button>
            <button class="clear-btn" onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>
    
    <div class="debug-card">
        <h2>ğŸ“‹ è¯¦ç»†è°ƒè¯•æ—¥å¿—</h2>
        <div id="logArea" class="log-area">ç­‰å¾…æ‰§è¡Œè°ƒè¯•...\n</div>
    </div>
    
    <div class="debug-card">
        <h2>ğŸ“Š è°ƒè¯•ç»“æœåˆ†æ</h2>
        <div id="analysisResult" class="log-area">å°šæœªæ‰§è¡Œè°ƒè¯•...\n</div>
    </div>
    
    <div class="debug-card">
        <h2>ğŸ“‹ è¯¦ç»†è¯·æ±‚å¤´ä¿¡æ¯</h2>
        <table id="headersTable">
            <thead>
                <tr>
                    <th>è¯·æ±‚å¤´</th>
                    <th>å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="2">ç­‰å¾…æ‰§è¡Œè°ƒè¯•...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // æ›´æ–°é¡µé¢ä¿¡æ¯
        function updatePageInfo() {
            document.getElementById('currentURL').textContent = window.location.href;
            document.getElementById('currentHost').textContent = window.location.host;
            document.getElementById('currentProtocol').textContent = window.location.protocol;
            document.getElementById('currentPort').textContent = window.location.port || 'é»˜è®¤ç«¯å£';
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            
            let typeClass = '';
            switch(type) {
                case 'success':
                    typeClass = 'âœ… ';
                    break;
                case 'error':
                    typeClass = 'âŒ ';
                    break;
                case 'warning':
                    typeClass = 'âš ï¸ ';
                    break;
                case 'info':
                    typeClass = 'â„¹ï¸ ';
                    break;
                default:
                    typeClass = 'ğŸ” ';
            }
            
            logArea.textContent += `[${timestamp}] ${typeClass}${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('logArea').textContent = '';
            document.getElementById('analysisResult').textContent = 'ç­‰å¾…æ‰§è¡Œè°ƒè¯•...\n';
            document.querySelector('#headersTable tbody').innerHTML = '<tr><td colspan="2">ç­‰å¾…æ‰§è¡Œè°ƒè¯•...</td></tr>';
        }
        
        // æµ‹è¯•APIè°ƒç”¨
        function testAPICall() {
            addLog('ğŸ“¡ å¼€å§‹æµ‹è¯•å±€åŸŸç½‘æ£€æµ‹API...', 'info');
            
            fetch('/api/lan-check')
                .then(response => {
                    addLog(`ğŸ“¡ APIå“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    addLog('âœ… å±€åŸŸç½‘æ£€æµ‹APIè°ƒç”¨æˆåŠŸ', 'success');
                    addLog('ğŸ“Š APIè¿”å›æ•°æ®:', 'info');
                    addLog(JSON.stringify(data, null, 2), 'info');
                    
                    // æ˜¾ç¤ºè¯¦ç»†åˆ†æç»“æœ
                    showDetailedAnalysis(data);
                })
                .catch(error => {
                    addLog(`âŒ å±€åŸŸç½‘æ£€æµ‹APIè°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
                    addLog('ğŸ”§ å¯èƒ½çš„åŸå› :', 'warning');
                    addLog('   1. åç«¯æœåŠ¡æœªå¯åŠ¨', 'warning');
                    addLog('   2. ç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
                    addLog('   3. APIè·¯å¾„é”™è¯¯', 'warning');
                });
        }
        
        // æµ‹è¯•æ‰‹åŠ¨IP
        function testManualIP() {
            const ip = document.getElementById('manualIP').value.trim();
            if (!ip) {
                alert('è¯·è¾“å…¥IPåœ°å€');
                return;
            }
            
            addLog(`ğŸ§ª å¼€å§‹æµ‹è¯•æ‰‹åŠ¨IP: ${ip}`, 'info');
            
            // æ¨¡æ‹ŸAPIè¿”å›æ•°æ®
            const mockData = {
                success: true,
                current_host: window.location.host,
                client_ip: ip,
                local_ip: '192.168.3.147',
                is_ip_access: false,
                is_client_in_lan: isLANIP(ip),
                need_switch_prompt: !isIPAccess() && isLANIP(ip),
                lan_url: 'http://192.168.3.147:9405',
                user_agent: navigator.userAgent,
                referrer: ''
            };
            
            addLog('ğŸ“Š æ¨¡æ‹Ÿæ•°æ®:', 'info');
            addLog(JSON.stringify(mockData, null, 2), 'info');
            
            // æ˜¾ç¤ºè¯¦ç»†åˆ†æç»“æœ
            showDetailedAnalysis(mockData);
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå±€åŸŸç½‘IP
        function isLANIP(ip) {
            // å¤„ç†IPv6å›ç¯åœ°å€
            if (ip === '::1') {
                return true;
            }
            
            // å¤„ç†IPv4åœ°å€
            const ipParts = ip.split('.');
            if (ipParts.length !== 4) {
                return false;
            }
            
            const firstPart = parseInt(ipParts[0]);
            const secondPart = parseInt(ipParts[1]);
            
            // 192.168.x.x
            if (firstPart === 192 && secondPart === 168) {
                return true;
            }
            // 10.x.x.x
            if (firstPart === 10) {
                return true;
            }
            // 172.16-31.x.x
            if (firstPart === 172 && secondPart >= 16 && secondPart <= 31) {
                return true;
            }
            // å›ç¯åœ°å€
            if (ip === '127.0.0.1') {
                return true;
            }
            
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºIPè®¿é—®
        function isIPAccess() {
            const host = window.location.host;
            const hostname = host.split(':')[0];
            return /^(\d{1,3}\.){3}\d{1,3}/.test(hostname);
        }
        
        // æ˜¾ç¤ºå±€åŸŸç½‘åˆ‡æ¢æç¤º
        function showLANSwitchPrompt(detectionData) {
            console.log('ğŸ“¢ showLANSwitchPrompt è¢«è°ƒç”¨ï¼Œæ•°æ®:', detectionData);
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ˜¾ç¤ºæç¤ºï¼Œé¿å…é‡å¤
            const existingModal = document.getElementById('lanSwitchModal');
            if (existingModal) {
                console.log('âš ï¸ å±€åŸŸç½‘åˆ‡æ¢æç¤ºå·²å­˜åœ¨ï¼Œè·³è¿‡');
                console.log('ğŸ”§ ç°æœ‰æç¤ºæ¡†:', existingModal);
                console.log('ğŸ”§ ç°æœ‰æç¤ºæ¡†æ ·å¼:', existingModal.style);
                console.log('ğŸ”§ ç°æœ‰æç¤ºæ¡†æ˜¾ç¤ºçŠ¶æ€:', getComputedStyle(existingModal).display);
                return;
            }
            
            console.log('ğŸ”” å¼€å§‹åˆ›å»ºå±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†');
            
            // æ˜¾ç¤ºé€šçŸ¥
            if (typeof showNotification === 'function') {
                showNotification('æ£€æµ‹åˆ°å±€åŸŸç½‘ç¯å¢ƒï¼Œå‡†å¤‡æ˜¾ç¤ºåˆ‡æ¢æç¤º...', 'info');
            }
            
            // ç¡®ä¿DOMå·²å‡†å¤‡å¥½
            console.log('ğŸ“„ DOMå‡†å¤‡çŠ¶æ€æ£€æŸ¥:');
            console.log('  - document.readyState:', document.readyState);
            console.log('  - document.bodyå­˜åœ¨:', !!document.body);
            
            if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
                console.log('â³ DOMæœªå‡†å¤‡å¥½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ...');
                window.addEventListener('load', () => {
                    console.log('âœ… window.loadäº‹ä»¶è§¦å‘');
                    createLANSwitchModal(detectionData);
                }, {once: true});
                
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('âœ… DOMContentLoadedäº‹ä»¶è§¦å‘');
                    createLANSwitchModal(detectionData);
                }, {once: true});
            } else {
                console.log('âœ… DOMå·²å‡†å¤‡å¥½ï¼Œç›´æ¥åˆ›å»ºæç¤ºæ¡†');
                createLANSwitchModal(detectionData);
            }
        }

        // åˆ›å»ºå±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¨¡æ€æ¡†
        function createLANSwitchModal(detectionData) {
            console.log('ğŸ”¨ å¼€å§‹åˆ›å»ºå±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¨¡æ€æ¡†');
            console.log('ğŸ“Š æ¥æ”¶åˆ°çš„æ•°æ®:', detectionData);
            
            // å†æ¬¡æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingModal = document.getElementById('lanSwitchModal');
            if (existingModal) {
                console.log('âš ï¸ å±€åŸŸç½‘åˆ‡æ¢æç¤ºå·²å­˜åœ¨ï¼Œè·³è¿‡');
                return;
            }
            
            // ç¡®ä¿bodyå…ƒç´ å­˜åœ¨
            console.log('ğŸ“„ bodyå…ƒç´ æ£€æŸ¥:');
            console.log('  - document.bodyå­˜åœ¨:', !!document.body);
            if (document.body) {
                console.log('  - document.body.style.display:', document.body.style.display);
            }
            
            if (!document.body) {
                console.log('â³ bodyå…ƒç´ æœªå‡†å¤‡å¥½ï¼Œç­‰å¾…DOMåŠ è½½å®Œæˆ...');
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        console.log('âœ… DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œé‡æ–°åˆ›å»ºæç¤ºæ¡†');
                        createLANSwitchModal(detectionData);
                    }, {once: true});
                } else {
                    console.log('â° å»¶è¿Ÿ100msåé‡è¯•...');
                    setTimeout(() => {
                        createLANSwitchModal(detectionData);
                    }, 100);
                }
                return;
            }
            
            // å¼ºåˆ¶ç¡®ä¿bodyå­˜åœ¨å¹¶å¯è§
            if (!document.body || document.body.style.display === 'none') {
                console.log('ğŸ”§ ç¡®ä¿bodyå…ƒç´ å¯è§...');
                document.body.style.display = 'block';
            }
            
            console.log('ğŸ”§ å¼€å§‹åˆ›å»ºDOMå…ƒç´ ...');
            
            const modal = document.createElement('div');
            modal.id = 'lanSwitchModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(2px);
                animation: fadeIn 0.3s ease-out;
            `;
            
            console.log('ğŸ”§ modalå…ƒç´ åˆ›å»ºå®Œæˆ:', modal);
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                transform: translateY(20px);
                animation: slideUp 0.3s ease-out forwards;
                text-align: center;
            `;
            
            modalContent.innerHTML = `
                <h2 style="margin-top: 0; color: #2c3e50;">ğŸš€ æ£€æµ‹åˆ°å±€åŸŸç½‘ç¯å¢ƒ</h2>
                <p style="font-size: 16px; color: #555; line-height: 1.6;">
                    æ£€æµ‹åˆ°æ‚¨æ­£åœ¨å±€åŸŸç½‘ç¯å¢ƒä¸­è®¿é—®ï¼Œä¸ºäº†è·å¾—æ›´å¿«çš„è®¿é—®é€Ÿåº¦ï¼Œ
                    å»ºè®®åˆ‡æ¢åˆ°å±€åŸŸç½‘åœ°å€ï¼š
                </p>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <strong style="font-size: 18px; color: #2c3e50;">${detectionData.lan_url}</strong>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="switchToLAN('${detectionData.lan_url}')" style="
                        background: #3498db;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 500;
                        transition: all 0.2s;
                    ">ç«‹å³åˆ‡æ¢</button>
                    <button onclick="closeLANSwitchModal()" style="
                        background: #ecf0f1;
                        color: #2c3e50;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: 500;
                        transition: all 0.2s;
                    ">ç¨åå†è¯´</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            console.log('âœ… å±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†åˆ›å»ºå®Œæˆ');
            addLog('âœ… å±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†å·²æ˜¾ç¤º', 'success');
        }

        // åˆ‡æ¢åˆ°å±€åŸŸç½‘åœ°å€
        function switchToLAN(lanURL) {
            addLog(`ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°å±€åŸŸç½‘åœ°å€: ${lanURL}`, 'info');
            console.log('ğŸ”„ åˆ‡æ¢åˆ°å±€åŸŸç½‘åœ°å€:', lanURL);
            
            // å…³é—­æç¤ºæ¡†
            closeLANSwitchModal();
            
            // è·³è½¬åˆ°å±€åŸŸç½‘åœ°å€
            setTimeout(() => {
                window.location.href = lanURL;
            }, 500);
        }

        // å…³é—­å±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†
        function closeLANSwitchModal() {
            const modal = document.getElementById('lanSwitchModal');
            if (modal) {
                modal.remove();
                console.log('ğŸ§¹ å±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†å·²å…³é—­');
                addLog('ğŸ§¹ å±€åŸŸç½‘åˆ‡æ¢æç¤ºæ¡†å·²å…³é—­', 'info');
            }
        }
        
        // å¼ºåˆ¶æ˜¾ç¤ºæç¤ºæ¡†
        function forceShowPrompt() {
            addLog('ğŸ”” å¼ºåˆ¶æ˜¾ç¤ºå±€åŸŸç½‘åˆ‡æ¢æç¤º...', 'info');
            
            // æ£€æŸ¥ç›¸å…³å‡½æ•°æ˜¯å¦å­˜åœ¨
            addLog('ğŸ” æ£€æŸ¥ç›¸å…³å‡½æ•°æ˜¯å¦å­˜åœ¨...', 'info');
            
            if (typeof showLANSwitchPrompt === 'function') {
                addLog('âœ… showLANSwitchPrompt å‡½æ•°å­˜åœ¨', 'success');
            } else {
                addLog('âŒ showLANSwitchPrompt å‡½æ•°ä¸å­˜åœ¨', 'error');
            }
            
            if (typeof createLANSwitchModal === 'function') {
                addLog('âœ… createLANSwitchModal å‡½æ•°å­˜åœ¨', 'success');
            } else {
                addLog('âŒ createLANSwitchModal å‡½æ•°ä¸å­˜åœ¨', 'error');
            }
            
            // æ¨¡æ‹ŸAPIè¿”å›æ•°æ®
            const mockData = {
                success: true,
                current_host: window.location.host,
                client_ip: '192.168.3.100',
                local_ip: '192.168.3.147',
                is_ip_access: false,
                is_client_in_lan: true,
                need_switch_prompt: true,
                lan_url: 'http://192.168.3.147:9405',
                user_agent: navigator.userAgent,
                referrer: '',
                force_prompt: true
            };
            
            addLog('ğŸ”§ ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•æç¤ºæ˜¾ç¤º...', 'info');
            
            try {
                // å°è¯•è°ƒç”¨æ˜¾ç¤ºå‡½æ•°
                if (typeof showLANSwitchPrompt === 'function') {
                    showLANSwitchPrompt(mockData);
                    addLog('âœ… æˆåŠŸè°ƒç”¨ showLANSwitchPrompt å‡½æ•°', 'success');
                } else if (typeof createLANSwitchModal === 'function') {
                    createLANSwitchModal(mockData);
                    addLog('âœ… æˆåŠŸè°ƒç”¨ createLANSwitchModal å‡½æ•°', 'success');
                } else {
                    addLog('âŒ æœªæ‰¾åˆ°æ˜¾ç¤ºæç¤ºçš„ç›¸å…³å‡½æ•°', 'error');
                    addLog('ğŸ’¡ è¯·ç¡®ä¿åœ¨ä¸»é¡µä¸­æµ‹è¯•æ­¤åŠŸèƒ½', 'warning');
                    return;
                }
                
                // æ£€æŸ¥æç¤ºæ¡†æ˜¯å¦åˆ›å»ºæˆåŠŸ
                setTimeout(() => {
                    const modal = document.getElementById('lanSwitchModal');
                    if (modal) {
                        addLog('âœ… æç¤ºæ¡†å·²æˆåŠŸåˆ›å»ºå¹¶æ·»åŠ åˆ°é¡µé¢', 'success');
                        addLog('ğŸ’¡ å¦‚æœæœªçœ‹åˆ°æç¤ºæ¡†ï¼Œè¯·æ£€æŸ¥CSSæ ·å¼æˆ–z-indexè®¾ç½®', 'warning');
                    } else {
                        addLog('âŒ æç¤ºæ¡†æœªåˆ›å»ºæˆåŠŸ', 'error');
                        addLog('ğŸ”§ å¯èƒ½çš„åŸå› :', 'warning');
                        addLog('   1. DOMå…ƒç´ æœªæ­£ç¡®æ·»åŠ ', 'warning');
                        addLog('   2. CSSæ ·å¼é—®é¢˜', 'warning');
                        addLog('   3. JavaScriptæ‰§è¡Œå¼‚å¸¸', 'warning');
                    }
                }, 100);
                
            } catch (error) {
                addLog(`âŒ è°ƒç”¨æ˜¾ç¤ºå‡½æ•°æ—¶å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰å‡½æ•°
        function showAllFunctions() {
            addLog('ğŸ“‹ æ£€æŸ¥é¡µé¢ä¸­çš„æ‰€æœ‰å‡½æ•°...', 'info');
            
            const functions = [
                'performLANDetection',
                'showLANSwitchPrompt',
                'createLANSwitchModal',
                'isLANIP',
                'isIPAccess',
                'forceShowPrompt',
                'testAPICall',
                'testManualIP'
            ];
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    addLog(`âœ… ${funcName}: å‡½æ•°å­˜åœ¨`, 'success');
                } else {
                    addLog(`âŒ ${funcName}: å‡½æ•°ä¸å­˜åœ¨`, 'error');
                }
            });
        }
        
        // æ˜¾ç¤ºè¯¦ç»†åˆ†æç»“æœ
        function showDetailedAnalysis(data) {
            let analysis = "ğŸ” è¯¦ç»†åˆ†æç»“æœ:\n\n";
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºåŸŸåè®¿é—®
            if (data.is_ip_access) {
                analysis += "âŒ é—®é¢˜1: å½“å‰æ˜¯é€šè¿‡IPåœ°å€è®¿é—®ï¼Œä¸æ˜¯åŸŸåè®¿é—®\n";
                analysis += "   è§£å†³æ–¹æ¡ˆ: è¯·é€šè¿‡åŸŸåè®¿é—®\n\n";
            } else {
                analysis += "âœ… æ£€æŸ¥1: å½“å‰æ˜¯é€šè¿‡åŸŸåè®¿é—®\n\n";
            }
            
            // æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦åœ¨å±€åŸŸç½‘
            if (!data.is_client_in_lan) {
                analysis += "âŒ é—®é¢˜2: å®¢æˆ·ç«¯ä¸åœ¨å±€åŸŸç½‘ç¯å¢ƒ\n";
                analysis += `   å½“å‰å®¢æˆ·ç«¯IP: ${data.client_ip}\n`;
                analysis += "   è§£å†³æ–¹æ¡ˆ: è¯·ç¡®ä¿åœ¨å±€åŸŸç½‘ç¯å¢ƒä¸­è®¿é—®\n\n";
            } else {
                analysis += "âœ… æ£€æŸ¥2: å®¢æˆ·ç«¯åœ¨å±€åŸŸç½‘ç¯å¢ƒ\n\n";
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æç¤º
            if (data.need_switch_prompt) {
                analysis += "âœ… æ£€æŸ¥3: æ»¡è¶³æ˜¾ç¤ºæç¤ºçš„æ‰€æœ‰æ¡ä»¶\n";
                analysis += "   åº”è¯¥æ˜¾ç¤ºæ™ºèƒ½åˆ‡æ¢æç¤º\n\n";
            } else {
                analysis += "âŒ é—®é¢˜3: ä¸æ»¡è¶³æ˜¾ç¤ºæç¤ºçš„æ¡ä»¶\n";
                if (!data.is_ip_access && data.is_client_in_lan && !data.need_switch_prompt) {
                    analysis += "   å¯èƒ½æ˜¯å±€åŸŸç½‘åœ°å€æµ‹è¯•å¤±è´¥\n";
                    analysis += `   å±€åŸŸç½‘åœ°å€: ${data.lan_url}\n`;
                    analysis += `   æœ¬æœºIP: ${data.local_ip}\n\n`;
                }
            }
            
            // æ£€æŸ¥æœ¬æœºIPæ˜¯å¦æ­£ç¡®
            if (data.local_ip === "127.0.0.1" || data.local_ip === "::1") {
                analysis += "âš ï¸ è­¦å‘Š: æœ¬æœºIPä¸ºå›ç¯åœ°å€\n";
                analysis += "   è¿™å¯èƒ½å¯¼è‡´å±€åŸŸç½‘åœ°å€æµ‹è¯•å¤±è´¥\n\n";
            }
            
            analysis += "ğŸ“‹ å»ºè®®æ“ä½œ:\n";
            analysis += "1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰JavaScripté”™è¯¯\n";
            analysis += "2. ç¡®è®¤é€šè¿‡åŸŸåè®¿é—®\n";
            analysis += "3. ç¡®ä¿åœ¨å±€åŸŸç½‘ç¯å¢ƒä¸­è®¿é—®\n";
            analysis += "4. å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ\n";
            
            document.getElementById('analysisResult').textContent = analysis;
            
            // æ˜¾ç¤ºè¯·æ±‚å¤´ä¿¡æ¯
            displayRequestHeaders();
        }
        
        // æ˜¾ç¤ºè¯·æ±‚å¤´ä¿¡æ¯
        function displayRequestHeaders() {
            const headers = {
                'Host': window.location.host,
                'Origin': window.location.origin,
                'User-Agent': navigator.userAgent,
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Online': navigator.onLine,
                'Cookies': document.cookie || 'æ— '
            };
            
            const tbody = document.querySelector('#headersTable tbody');
            tbody.innerHTML = '';
            
            for (const [key, value] of Object.entries(headers)) {
                const row = document.createElement('tr');
                row.innerHTML = `<td><strong>${key}</strong></td><td>${value}</td>`;
                tbody.appendChild(row);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            updatePageInfo();
            addLog('ğŸ“„ å¢å¼ºç‰ˆæ™ºèƒ½æ£€æµ‹è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ', 'success');
            addLog('ğŸ’¡ è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info');
        });
    </script>
</body>
</html>